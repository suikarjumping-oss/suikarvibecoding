<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EMT-1 ç´™ä¸Šå…µæ¨ V15 | XABCDE & å±æ©Ÿæ³¨å…¥ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* --- 1. Design System (MUJI / Tabletop Style) --- */
        :root {
            --bg-color: #E6E2D8; 
            --paper-color: #FDFBF7;
            --text-main: #2F2F2F; 
            --text-sub: #666;  
            --primary: #2C3E50;
            --accent: #A93226;    
            --success: #1E8449;   
            --crisis: #C0392B;    
            
            --radius: 2px;
            --border: 1px solid #C0B7A8;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            background-image: repeating-linear-gradient(0deg, transparent, transparent 19px, #D8D4C9 20px);
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden; 
        }

        /* --- Header --- */
        header {
            padding: 12px 16px;
            background: #F4F3EF;
            border-bottom: 2px solid #C0B7A8;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            z-index: 10;
        }
        h1 { font-size: 1.1rem; font-weight: 700; margin: 0; color: var(--text-main); letter-spacing: 1px; }
        
        .mute-btn {
            background: none; border: 1px solid #999;
            color: #666; padding: 4px 10px; border-radius: 4px;
            cursor: pointer; font-size: 0.85rem;
        }
        .mute-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }

        /* --- Tabs --- */
        .tab-container {
            display: flex; padding: 0 16px;
            background: #F4F3EF;
            border-bottom: 1px solid #C0B7A8;
        }
        .tab {
            flex: 1; text-align: center; padding: 12px 0;
            color: #888; cursor: pointer; font-size: 0.95rem; font-weight: 500;
            border-bottom: 3px solid transparent; transition: all 0.2s;
        }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 700; }

        /* --- Main Content --- */
        main {
            flex: 1; overflow-y: auto; padding: 20px;
            max-width: 700px; margin: 0 auto; width: 100%;
            padding-bottom: 100px;
            scroll-behavior: smooth;
        }

        /* --- The "Patient File" Card --- */
        .file-folder {
            background: var(--paper-color);
            border: 1px solid #C0B7A8;
            border-radius: 4px;
            box-shadow: 1px 1px 0 rgba(0,0,0,0.05), 3px 3px 0 rgba(0,0,0,0.05);
            padding: 0;
            margin-bottom: 20px;
            overflow: hidden;
            position: relative;
            transition: all 0.3s;
        }
        
        .file-folder.crisis-mode {
            border: 4px solid var(--crisis);
            box-shadow: 0 0 20px rgba(192, 57, 43, 0.5);
            animation: shake 0.5s infinite alternate;
        }
        
        .crisis-overlay-msg {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(192, 57, 43, 0.9); color: white; padding: 20px;
            font-size: 1.5rem; font-weight: bold; border-radius: 8px; z-index: 20;
            text-align: center; pointer-events: none; display: none;
        }
        .file-folder.crisis-mode .crisis-overlay-msg { display: block; }

        .file-header {
            background: #F0EFE9;
            padding: 12px 20px;
            border-bottom: 2px solid #DCD8CF;
            display: flex; justify-content: space-between; align-items: center;
        }
        .crisis-mode .file-header { background: #FADBD8; border-bottom-color: #E6B0AA; }
        
        .case-id { font-family: 'Roboto Mono', monospace; font-weight: 700; color: #555; letter-spacing: 1px; }
        .stamp-box { border: 2px dashed #ccc; color: #ccc; padding: 2px 8px; font-size: 0.8rem; transform: rotate(-5deg); font-weight: 700; }
        .stamp-box.assessed { border-color: var(--accent); color: var(--accent); }

        .file-body { padding: 20px; }

        /* Visual Polaroid */
        .polaroid {
            background: #fff; padding: 8px 8px 25px 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transform: rotate(1deg);
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }
        .polaroid img { width: 100%; height: 160px; object-fit: cover; filter: sepia(10%) contrast(95%); }
        .polaroid-caption { font-size: 0.9rem; color: #444; margin-top: 8px; font-family: 'Courier New', monospace; }

        /* Investigation Grid */
        .investigation-grid {
            display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;
            margin-bottom: 10px;
        }
        .btn-investigate {
            background: #fff; border: 1px solid #aaa;
            padding: 15px 5px; text-align: center; cursor: pointer;
            border-radius: 2px; transition: all 0.2s;
            font-size: 0.9rem; color: #444;
            display: flex; flex-direction: column; align-items: center; gap: 5px;
        }
        .btn-investigate:hover { background: #fdfdfd; border-color: var(--primary); }
        .btn-investigate:disabled { opacity: 0.5; background: #eee; cursor: not-allowed; }
        .btn-investigate.checked { background: #F4F8F0; border-color: var(--success); color: var(--success); }

        /* GCS Detailed Calculator Style */
        .gcs-panel {
            background: #F2F4F4; border: 1px solid #BDC3C7; padding: 15px;
            margin-bottom: 20px; border-radius: var(--radius); display: none;
        }
        .gcs-panel.active { display: block; animation: fadeIn 0.3s; }
        .gcs-row { margin-bottom: 10px; }
        .gcs-label { font-size: 0.9rem; font-weight: bold; color: var(--primary); margin-bottom: 5px; display: block; }
        .gcs-btn-group { display: flex; gap: 5px; flex-wrap: wrap; }
        .gcs-btn {
            flex: 1; padding: 8px 5px; border: 1px solid #999; background: #fff;
            cursor: pointer; font-size: 0.9rem; color: #555;
        }
        .gcs-btn:hover { background: #eee; }
        .gcs-btn.selected { background: var(--primary); color: #fff; border-color: var(--primary); }
        
        .gcs-summary {
            margin-top: 15px; padding-top: 15px; border-top: 1px dashed #ccc;
            font-family: 'Roboto Mono', monospace; font-size: 1.1rem; text-align: center; font-weight: bold; color: var(--text-main);
        }
        
        .gcs-critical-check {
            margin-top: 10px; display: flex; gap: 10px; align-items: center; justify-content: center;
            background: #fff; padding: 10px; border: 1px solid #ddd;
        }
        .gcs-confirm-btn {
            width: 100%; margin-top: 10px; padding: 10px; background: #27AE60; color: white;
            border: none; cursor: pointer; font-weight: bold;
        }

        /* Handwriting Log */
        .notebook-log {
            background: #fff;
            border: 1px solid #ddd;
            padding: 15px;
            min-height: 120px;
            font-family: 'Courier New', monospace;
            font-size: 0.95rem;
            line-height: 1.6;
            color: #333;
            background-image: linear-gradient(#eee 1px, transparent 1px);
            background-size: 100% 1.6em;
            margin-bottom: 20px;
            max-height: 300px; overflow-y: auto;
        }
        
        /* Script Style */
        .script-line { margin-bottom: 6px; }
        .script-you { color: #2C3E50; font-weight: bold; }
        .script-patient { color: #666; font-style: italic; margin-left: 10px; }
        .script-action { color: #A04000; font-weight: 500; }
        
        .note-entry { margin-bottom: 0; white-space: pre-wrap; }
        .note-highlight { background: rgba(244, 208, 63, 0.2); padding: 0 4px; }
        .note-crisis { color: var(--crisis); font-weight: bold; background: rgba(192, 57, 43, 0.1); padding: 2px 4px; }
        .note-feedback { color: #8E44AD; border-left: 3px solid #8E44AD; padding-left: 5px; margin-top: 5px; font-weight: 500;}

        /* Action Buttons */
        .action-area { border-top: 2px dashed #ddd; padding-top: 20px; }
        .question-text { font-weight: 700; margin-bottom: 15px; color: var(--primary); }
        
        .btn-decision {
            width: 100%; padding: 14px; margin-bottom: 8px;
            background: #fff; border: 1px solid #999; border-radius: 3px;
            font-size: 1rem; text-align: left; cursor: pointer;
            box-shadow: 0 2px 0 #ccc; transition: transform 0.1s;
        }
        .btn-decision:active { transform: translateY(2px); box-shadow: none; }
        .btn-decision:hover { border-color: var(--primary); }
        
        .btn-decision.correct { background: #DFF0D8; border-color: #3C763D; color: #3C763D; }
        .btn-decision.wrong { background: #F2DEDE; border-color: #A94442; color: #A94442; }
        .btn-decision.crisis-btn { border-color: var(--crisis); color: var(--crisis); font-weight: bold; }

        /* Roulette Screen */
        #roulette-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(230, 226, 216, 0.98); z-index: 50;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner-text { font-size: 2rem; font-weight: 700; color: var(--primary); font-family: 'Courier New', monospace; border: 4px solid var(--primary); padding: 10px 20px; transform: rotate(-2deg); }

        /* Crisis Badge */
        .crisis-badge {
            display: none;
            background: var(--crisis); color: white; padding: 4px 12px;
            font-size: 0.9rem; font-weight: bold; border-radius: 12px;
            animation: pulse 1s infinite;
        }

        /* Review Mode */
        .quiz-card { background: #fff; padding: 20px; border: 1px solid #ccc; margin-bottom: 15px; box-shadow: 2px 2px 0 #ddd; }
        
        /* Hint */
        .hint-toggle { font-size: 0.8rem; color: #888; text-decoration: underline; cursor: pointer; margin-top: 10px; display: inline-block; }
        .hint-content { display: none; background: #FFFEE0; border: 1px solid #E6DB55; padding: 10px; font-size: 0.9rem; margin-top: 5px; color: #555; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } 100% { transform: translateX(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    </style>
</head>
<body>

    <!-- Start / Roulette Screen -->
    <div id="roulette-overlay">
        <h1 style="color:var(--primary); margin-bottom:20px;">EMT-1 ç´™ä¸Šå…µæ¨ V15</h1>
        <p style="color:#666; margin-bottom:30px; font-family:'Courier New'; text-align:center;">
            æ²‰æµ¸å¼åŠ‡æœ¬æ¨¡æ“¬<br>
            <span style="font-size:0.8rem; color:var(--crisis);"âš ï¸ è½å¯¦ XABCDE & å‹•æ…‹å±æ©Ÿæ³¨å…¥</span>
        </p>
        <button class="btn-decision" style="width:auto; padding:12px 40px; background:var(--primary); color:#fff; text-align:center;" onclick="app.init()">æŠ½å–å‚·æƒ…å¡ Draw Case</button>
    </div>

    <header>
        <h1>EMT-1 Wargame <span style="font-size:0.7rem; color:#888;">V15</span></h1>
        <button id="mute-toggle" class="mute-btn" onclick="audioSys.toggleMute()">ğŸ”Š éŸ³æ•ˆ</button>
    </header>

    <div class="tab-container">
        <div id="tab-scenario" class="tab active" onclick="app.switchMode('scenario')">å‚·æƒ…å…µæ¨</div>
        <div id="tab-review" class="tab" onclick="app.switchMode('review')">å­¸ç†è¤‡ç¿’</div>
    </div>

    <main id="app-container">
        <!-- Content will be injected here -->
    </main>

    <script>
        /* =========================================
           1. DATA: Patient Database
           ========================================= */
        const getImg = (text) => `https://placehold.co/600x350/EAE8E2/555555?text=${encodeURIComponent(text)}&font=roboto`;

        const CASES_DB = [
            {
                id: "MCI-01", type: "Black",
                img: getImg("SCENE: Collapsed Structure"),
                impression: "ç™¼ç¾å‚·æ‚£ä¸ŠåŠèº«è¢«å·¨å¤§æ°´æ³¥å¡Šå£“ä½ï¼Œèº«é«”å‘ˆç¾ä¸è‡ªç„¶æ‰­æ›²ã€‚",
                assessments: {
                    script_voice: `<span class='script-you'>ä½ ï¼š</span>ã€Œå…ˆç”Ÿå…ˆç”Ÿï¼è½å¾—åˆ°æˆ‘çš„è²éŸ³å—ï¼Ÿ(è©•ä¼°E)ã€\n<span class='script-patient'>æ‚£è€…ï¼š</span>(æ¯«ç„¡åæ‡‰)\n<span class='script-you'>ä½ ï¼š</span>ã€Œå…ˆç”Ÿï¼èƒ½å‘Šè¨´æˆ‘ç™¼ç”Ÿä»€éº¼äº‹å—ï¼Ÿ(è©•ä¼°V)ã€\n<span class='script-patient'>æ‚£è€…ï¼š</span>(æ²’æœ‰å‡ºè²)\n<span class='script-you'>ä½ ï¼š</span>ã€Œè«‹å‹•ä¸€ä¸‹æ‰‹æŒ‡è®“æˆ‘çœ‹åˆ°ï¼(è©•ä¼°M)ã€\n<span class='script-patient'>æ‚£è€…ï¼š</span>(å®Œå…¨æ²’æœ‰å‹•ä½œ)`,
                    script_pain: `<span class='script-you'>ä½ ï¼š</span>(ç”¨åŠ›æŒ‰å£“æ–œæ–¹è‚Œ)\n<span class='script-patient'>æ‚£è€…ï¼š</span>(å…¨èº«ç™±è»Ÿï¼Œç„¡è‚Œè‚‰æ”¶ç¸®åæ‡‰)`,
                    breathing: "è§€å¯Ÿèƒ¸éƒ¨èµ·ä¼ã€‚\nçµæœï¼š**10ç§’é˜å…§æ²’æœ‰è§€å¯Ÿåˆ°ä»»ä½•èµ·ä¼ (0æ¬¡)ã€‚**",
                    pulse: "è§¸æ‘¸é ¸å‹•è„ˆã€‚\nçµæœï¼šæ‘¸ä¸åˆ°è„ˆæã€‚",
                    gcs: { e: 1, v: 1, m: 1 },
                    gcs_exp: "ç„¡åæ‡‰(E1)ã€ç„¡ç™¼è²(V1)ã€ç„¡é‹å‹•(M1)ã€‚",
                    is_critical: true
                },
                start_phase: "start_black"
            },
            {
                id: "MCI-02", type: "Red",
                img: getImg("PATIENT: Clutching Throat"),
                impression: "ç”·æ€§å€’è‡¥åœ¨åœ°ï¼Œé›™æ‰‹ç·ŠæŠ“å–‰åš¨ï¼Œè¡¨æƒ…æ¥µåº¦ææ…Œ (ç–‘ä¼¼å‘¼å¸é“é˜»å¡)ã€‚",
                assessments: {
                    script_voice: `<span class='script-you'>ä½ ï¼š</span>ã€Œå…ˆç”Ÿï¼è½å¾—åˆ°å—ï¼Ÿä½ çœ‹è‘—æˆ‘ï¼(è©•ä¼°E)ã€\n<span class='script-patient'>æ‚£è€…ï¼š</span>(å¼µå¤§çœ¼ç›çœ‹è‘—ä½ ï¼Œç¥æƒ…ææ…Œ)\n<span class='script-you'>ä½ ï¼š</span>ã€Œä½ å«ä»€éº¼åå­—ï¼Ÿ(è©•ä¼°V)ã€\n<span class='script-patient'>æ‚£è€…ï¼š</span>(å¼µå£è©¦åœ–èªªè©±ï¼Œä½†åªèƒ½ç™¼å‡ºå˜¶å˜¶çš„æ°£éŸ³)\n<span class='script-you'>ä½ ï¼š</span>ã€Œç”¨åŠ›æ¡ä½æˆ‘çš„æ‰‹ï¼(è©•ä¼°M)ã€\n<span class='script-patient'>æ‚£è€…ï¼š</span>(ç”¨åŠ›æ¡ä½ä½ çš„æ‰‹)`,
                    script_pain: `<span class='script-you'>ä½ ï¼š</span>(ä¸éœ€ç—›åˆºæ¿€ï¼Œæ‚£è€…æ¸…é†’å¯éµå¾æŒ‡ä»¤)`,
                    breathing: "è½è¨ºå‘¼å¸éŸ³ã€‚\nçµæœï¼šè½åˆ°å–˜é³´è² (Stridor)ã€‚**å‘¼å¸æ¥µåº¦è²»åŠ›æ·ºå¿«ï¼Œè§€å¯Ÿ 10 ç§’ç´„ 6 ä¸‹ã€‚**",
                    pulse: "æ©ˆå‹•è„ˆï¼šå¿«è€Œå¼±ï¼Œç´„ 130/minã€‚",
                    gcs: { e: 4, v: 1, m: 6 },
                    gcs_exp: "è‡ªå‹•å¼µçœ¼(E4)ï¼›æ°£é“é˜»å¡ç„¡æ³•ç™¼è²è¦–ç‚º(V1)æˆ–ä¾æ’ç®¡å®šç¾©ç‚ºTï¼Œæ­¤è™•è©•V1ï¼›èƒ½éµå¾æ¡æ‰‹æŒ‡ä»¤(M6)ã€‚",
                    is_critical: true
                },
                start_phase: "start_red_airway"
            },
            {
                id: "MCI-03", type: "Red",
                img: getImg("SCENE: Massive Bleeding"),
                impression: "å¥³æ€§å°–å«å‘¼æ•‘ï¼Œå³å¤§è…¿æ ¹éƒ¨æœ‰å¤§é‡é®®è¡€å™´æ¿º (Arterial Spray)ã€‚",
                assessments: {
                    script_voice: `<span class='script-you'>ä½ ï¼š</span>ã€Œå°å§ï¼ä½ é‚„å¥½å—ï¼Ÿ(è©•ä¼°E)ã€\n<span class='script-patient'>æ‚£è€…ï¼š</span>(æŒçºŒçœ‹è‘—ä½ å°–å«)\n<span class='script-you'>ä½ ï¼š</span>ã€Œå¿«å‘Šè¨´æˆ‘å“ªè£¡ç—›ï¼Ÿ(è©•ä¼°V)ã€\n<span class='script-patient'>æ‚£è€…ï¼š</span>ã€Œæ•‘å‘½ï¼æˆ‘çš„è…³ï¼å¥½å¤šè¡€ï¼ã€\n<span class='script-you'>ä½ ï¼š</span>ã€Œå¿«ï¼ç”¨é›™æ‰‹ç”¨åŠ›æŒ‰ä½å‚·å£ï¼(è©•ä¼°M)ã€\n<span class='script-patient'>æ‚£è€…ï¼š</span>(ç«‹åˆ»ç”¨é›™æ‰‹å»å£“ä½å¤§è…¿æ ¹éƒ¨)`,
                    script_pain: `<span class='script-you'>ä½ ï¼š</span>(ä¸éœ€ç—›åˆºæ¿€)`,
                    breathing: "è§€å¯Ÿèƒ¸éƒ¨ã€‚\nçµæœï¼š**å‘¼å¸æ·±å¿« (éåº¦æ›æ°£)ã€‚è§€å¯Ÿ 10 ç§’ç´„ 5 ä¸‹ã€‚**",
                    pulse: "æ©ˆå‹•è„ˆï¼šæ‘¸å¾—åˆ°ä½†å¾ˆæ€¥ä¿ƒ (140/min)ã€‚",
                    gcs: { e: 4, v: 5, m: 6 },
                    gcs_exp: "è‡ªå‹•å¼µçœ¼(E4)ï¼›å°ç­”å¦‚æµ(V5)ï¼›èƒ½è½ä»¤æŒ‰å£“å‚·å£(M6)ã€‚",
                    is_critical: true
                },
                start_phase: "start_red_amp"
            },
            {
                id: "MCI-04", type: "Red",
                img: getImg("PATIENT: Trapped Legs"),
                impression: "ç”·æ€§ä¸‹åŠèº«è¢«ç“¦ç¤«å †å£“ä½ï¼Œè‡‰è‰²è’¼ç™½ï¼Œçœ¼ç¥æ¸™æ•£ã€‚",
                assessments: {
                    script_voice: `<span class='script-you'>ä½ ï¼š</span>ã€Œå…ˆç”Ÿï¼å…ˆç”Ÿï¼(è©•ä¼°E)ã€\n<span class='script-patient'>æ‚£è€…ï¼š</span>(åŸæœ¬é–‰çœ¼ï¼Œè½åˆ°å‘¼å–šå¾Œç·©ç·©å¼µé–‹çœ¼)\n<span class='script-you'>ä½ ï¼š</span>ã€ŒçŸ¥é“ç™¼ç”Ÿä»€éº¼äº‹å—ï¼Ÿ(è©•ä¼°V)ã€\n<span class='script-patient'>æ‚£è€…ï¼š</span>(å£ä¸­ç™¼å‡ºå‘»åŸèˆ‡ç„¡æ³•è¾¨è­˜çš„å–®å­—)\n<span class='script-you'>ä½ ï¼š</span>ã€ŒæŠŠæ‰‹èˆ‰èµ·ä¾†çµ¦æˆ‘çœ‹ï¼(è©•ä¼°M)ã€\n<span class='script-patient'>æ‚£è€…ï¼š</span>(çœ¼ç¥æ¸™æ•£ï¼Œæ‰‹æ²’æœ‰èˆ‰èµ·ä¾†ï¼Œç„¡æ³•éµå¾æŒ‡ä»¤)`,
                    script_pain: `<span class='script-you'>ä½ ï¼š</span>(æŒ‰å£“æ–œæ–¹è‚Œçµ¦äºˆç–¼ç—›åˆºæ¿€)\n<span class='script-patient'>æ‚£è€…ï¼š</span>(ç™¼å‡ºå“€è™Ÿï¼Œæ‰‹å¿«é€Ÿç¸®å›é–ƒé¿)`,
                    breathing: "è§€å¯Ÿèƒ¸éƒ¨ã€‚\nçµæœï¼š**å‘¼å¸æ·ºå¿«ä¸è¦å‰‡ã€‚è§€å¯Ÿ 10 ç§’ç´„ 4-5 ä¸‹ã€‚**",
                    pulse: "æ©ˆå‹•è„ˆï¼šå¾®å¼±ï¼Œç´„ 120/minã€‚",
                    gcs: { e: 3, v: 2, m: 4 },
                    gcs_exp: "å‘¼å–šå¼µçœ¼(E3)ï¼›ç„¡æ³•ç†è§£çš„è²éŸ³(V2)ï¼›ç–¼ç—›å›ç¸®é–ƒé¿(M4)ã€‚",
                    is_critical: true
                },
                start_phase: "start_red_crush"
            },
            {
                id: "MCI-05", type: "Yellow",
                img: getImg("PATIENT: Holding Arm"),
                impression: "å¥³æ€§ååœ¨åœ°ä¸ŠæŠ±è‘—å·¦æ‰‹è‡‚ï¼Œè¡¨æƒ…ç—›è‹¦ã€‚",
                assessments: {
                    script_voice: `<span class='script-you'>ä½ ï¼š</span>ã€Œå°å§ï¼Œæˆ‘çœ‹å¦³æ‰‹å—å‚·äº†ï¼Ÿ(è©•ä¼°E)ã€\n<span class='script-patient'>æ‚£è€…ï¼š</span>(çœ‹è‘—ä½ é»é ­)\n<span class='script-you'>ä½ ï¼š</span>ã€Œé™¤äº†æ‰‹é‚„æœ‰å“ªè£¡ä¸èˆ’æœå—ï¼Ÿ(è©•ä¼°V)ã€\n<span class='script-patient'>æ‚£è€…ï¼š</span>ã€Œåªæœ‰æ‰‹...æ‰‹å¥½åƒæ–·äº†ï¼Œå¾ˆç—›ã€‚ã€\n<span class='script-you'>ä½ ï¼š</span>ã€Œå³æ‰‹æ²’å—å‚·å§ï¼Ÿå‹•å‹•æ‰‹æŒ‡çµ¦æˆ‘çœ‹ã€‚(è©•ä¼°M)ã€\n<span class='script-patient'>æ‚£è€…ï¼š</span>(ç…§æŒ‡ä»¤æ´»å‹•å³æ‰‹æ‰‹æŒ‡)`,
                    script_pain: `<span class='script-you'>ä½ ï¼š</span>(ä¸éœ€ç—›åˆºæ¿€)`,
                    breathing: "è§€å¯Ÿå‘¼å¸ã€‚\nçµæœï¼š**å‘¼å¸å¹³ç©©ã€‚è§€å¯Ÿ 10 ç§’ç´„ 3 ä¸‹ã€‚**",
                    pulse: "æ©ˆå‹•è„ˆï¼šå¼·è€Œæœ‰åŠ›ï¼Œç´„ 90/minã€‚",
                    gcs: { e: 4, v: 5, m: 6 },
                    gcs_exp: "æ¸…é†’ä¸”èƒ½éµå¾æŒ‡ä»¤ (E4V5M6)ã€‚",
                    is_critical: false
                },
                start_phase: "start_yellow_fracture"
            },
            {
                id: "BUS-01", type: "Red",
                img: getImg("PATIENT: Unconscious"),
                impression: "ç”·æ€§å€’åœ¨ç¢ç»ç’ƒä¸­ï¼Œç„¡æ„è­˜ï¼Œç™¼å‡ºé¼¾éŸ³ã€‚",
                assessments: {
                    script_voice: `<span class='script-you'>ä½ ï¼š</span>ã€Œå…ˆç”Ÿï¼å…ˆç”Ÿï¼è½å¾—åˆ°å—ï¼Ÿ(è©•ä¼°E)ã€\n<span class='script-patient'>æ‚£è€…ï¼š</span>(æ¯«ç„¡åæ‡‰ï¼Œçœ¼ç›ç·Šé–‰)\n<span class='script-you'>ä½ ï¼š</span>ã€Œå…ˆç”Ÿï¼è«‹ä½ æŠŠæ‰‹å‹•ä¸€ä¸‹ï¼(è©•ä¼°M)ã€\n<span class='script-patient'>æ‚£è€…ï¼š</span>(å®Œå…¨æ²’æœ‰å‹•ä½œ)`,
                    script_pain: `<span class='script-you'>ä½ ï¼š</span>(ç”¨åŠ›æèƒ¸å¤§è‚Œçµ¦äºˆå¼·çƒˆç—›åˆºæ¿€)\n<span class='script-patient'>æ‚£è€…ï¼š</span>(é›™æ‰‹åƒµç¡¬ä¼¸ç›´ï¼Œæ‰‹è…•å‘å¤–æ—‹è½‰)`,
                    breathing: "è§€å¯Ÿå‘¼å¸ã€‚\nçµæœï¼š**å‘¼å¸æ…¢ä¸”æ·±ã€‚è§€å¯Ÿ 10 ç§’ç´„ 2 ä¸‹ã€‚**",
                    pulse: "æ©ˆå‹•è„ˆï¼šç·©æ…¢æœ‰åŠ›ï¼Œç´„ 50/min (IICPå¾µè±¡)ã€‚",
                    gcs: { e: 1, v: 1, m: 2 },
                    gcs_exp: "ç—›åˆºæ¿€ä¸å¼µçœ¼(E1)ï¼›æ’ç®¡æˆ–ç„¡è²(V1)ï¼›å»å¤§è…¦ä¼¸å¼µ(M2)ã€‚",
                    is_critical: true
                },
                start_phase: "start_red_airway_snore"
            }
        ];

        /* =========================================
           2. APP LOGIC
           ========================================= */

        const app = {
            state: {
                case: null,
                history: [],
                phaseKey: null,
                availableCases: [],
                investigated: { voice: false, pain: false, breathing: false, pulse: false },
                gcsChecked: false,
                isCrisisActive: false,
                gcsInput: { e: 0, v: 0, m: 0, critical: null },
                x_treated: false
            },

            init: function() {
                audioSys.init();
                this.state.availableCases = [...CASES_DB];
                this.startRoulette();
            },

            switchMode: function(mode) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.getElementById(`tab-${mode}`).classList.add('active');
                
                if (mode === 'scenario') {
                    if(!this.state.case && this.state.availableCases.length > 0) this.startRoulette();
                    else if (this.state.case) this.renderPhase(this.state.phaseKey);
                } else {
                    this.renderReview();
                }
            },

            // --- Roulette ---
            startRoulette: function() {
                const overlay = document.getElementById('roulette-overlay');
                overlay.style.display = 'flex';
                
                if (this.state.availableCases.length === 0) {
                    overlay.innerHTML = `<h1 style="color:#1E8449">æ¼”ç·´å®Œæˆ</h1><p>æ‰€æœ‰å€‹æ¡ˆå·²çµæ¡ˆã€‚</p><button class="btn-decision" style="width:auto" onclick="location.reload()">é‡æ–°é–‹å§‹ Reset</button>`;
                    return;
                }

                overlay.innerHTML = `<div class="spinner-text">SEARCHING...</div>`;
                let count = 0;
                const interval = setInterval(() => {
                    const idx = Math.floor(Math.random() * this.state.availableCases.length);
                    const c = this.state.availableCases[idx];
                    overlay.querySelector('.spinner-text').innerText = c.id;
                    count++;
                    if(count > 12) {
                        clearInterval(interval);
                        overlay.style.display = 'none';
                        this.state.availableCases.splice(idx, 1);
                        this.startScenario(c);
                    }
                }, 80);
            },

            startScenario: function(c) {
                document.querySelector('main').scrollTop = 0;
                this.state.case = c;
                this.state.history = [`>> æ”¶åˆ°æ´¾é£: ${c.id}`, `>> æŠµé”ç¾å ´ï¼Œé–‹å§‹è©•ä¼°ã€‚`];
                this.state.investigated = { voice: false, pain: false, breathing: false, pulse: false };
                this.state.gcsChecked = false;
                this.state.isCrisisActive = false;
                this.state.x_treated = false;
                this.state.gcsInput = { e: 0, v: 0, m: 0, critical: null };
                this.renderPhase(c.start_phase || 'start_generic');
            },

            // --- Investigate Action ---
            investigate: function(type) {
                const c = this.state.case;
                let resultText = "";

                if(type === 'voice') {
                    resultText = `ğŸ—£ï¸ [æ„è­˜/æŒ‡ä»¤æ¸¬è©¦]\n${c.assessments.script_voice}`;
                    this.state.investigated.voice = true;
                } else if(type === 'pain') {
                    resultText = `âš¡ï¸ [ç—›è¦ºæ¸¬è©¦]\n${c.assessments.script_pain}`;
                    this.state.investigated.pain = true;
                } else if(type === 'breathing') {
                    resultText = `ğŸ« [å‘¼å¸] ${c.assessments.breathing}`;
                    this.state.investigated.breathing = true;
                } else if(type === 'pulse') {
                    resultText = `â¤ï¸ [å¾ªç’°] ${c.assessments.pulse}`;
                    this.state.investigated.pulse = true;
                }

                this.state.history.push(resultText);
                this.renderPhase(this.state.phaseKey);
            },

            // --- GCS Detailed Calculator ---
            setGCS: function(type, val) {
                this.state.gcsInput[type] = val;
                this.renderPhase(this.state.phaseKey); 
            },
            
            setGCSCritical: function(isCritical) {
                this.state.gcsInput.critical = isCritical;
                this.renderPhase(this.state.phaseKey);
            },

            getEName: function(v) { return ['ç„¡åæ‡‰','ç—›åˆºæ¿€','å‘¼å–š','è‡ªå‹•'][v-1] || ''; },
            getVName: function(v) { return ['ç„¡åæ‡‰','é›£ä»¥ç†è§£','ä¸ç•¶è¨€èª','æ··äº‚','æ¸…æ¥š'][v-1] || ''; },
            getMName: function(v) { return ['ç„¡åæ‡‰','ä¼¸å¼µ(å»è…¦)','å±ˆæ›²(å»çš®è³ª)','é€€ç¸®','å®šä½','è½ä»¤'][v-1] || ''; },

            submitGCS: function() {
                const user = this.state.gcsInput;
                const correct = this.state.case.assessments.gcs;
                const total = user.e + user.v + user.m;
                const correctTotal = correct.e + correct.v + correct.m;
                
                if(user.e === 0 || user.v === 0 || user.m === 0 || user.critical === null) {
                    alert("è«‹å®Œæˆæ‰€æœ‰ E, V, M åŠå±æ€¥åˆ¤æ–·æ¬„ä½ã€‚");
                    return;
                }

                // Detailed Logic Validation
                let feedback = [];
                let isAllCorrect = true;

                if (user.e !== correct.e) {
                    isAllCorrect = false;
                    feedback.push(`âŒ E éŒ¯èª¤ï¼šæ­£ç¢ºç‚º E${correct.e} (${this.getEName(correct.e)})`);
                }
                if (user.v !== correct.v) {
                    isAllCorrect = false;
                    feedback.push(`âŒ V éŒ¯èª¤ï¼šæ­£ç¢ºç‚º V${correct.v} (${this.getVName(correct.v)})`);
                }
                if (user.m !== correct.m) {
                    isAllCorrect = false;
                    feedback.push(`âŒ M éŒ¯èª¤ï¼šæ­£ç¢ºç‚º M${correct.m} (${this.getMName(correct.m)})`);
                }
                
                // ALS Critical Definition Check (Based on PHTLS/ALS criteria, not just GCS)
                const isCaseCritical = this.state.case.is_critical;
                const userThinkCritical = user.critical;
                
                if (userThinkCritical !== isCaseCritical) {
                    isAllCorrect = false;
                    if(isCaseCritical) {
                        feedback.push(`âŒ å±æ€¥åˆ¤æ–·éŒ¯èª¤ï¼šæ­¤å€‹æ¡ˆç‚ºå±æ€¥å€‹æ¡ˆï¼(åŸå› ï¼š${this.getCriticalReason()})`);
                    } else {
                        feedback.push(`âŒ å±æ€¥åˆ¤æ–·éŒ¯èª¤ï¼šæ­¤å€‹æ¡ˆç”Ÿå‘½å¾µè±¡ç©©å®šï¼Œé ALS å±æ€¥å€‹æ¡ˆã€‚`);
                    }
                }

                if (isAllCorrect) {
                    audioSys.playTone('correct');
                    this.state.history.push(`>> âœ… GCS èˆ‡å±æ€¥åˆ¤æ–·å®Œå…¨æ­£ç¢ºï¼ (E${user.e}V${user.v}M${user.m}=${total})`);
                } else {
                    audioSys.playTone('wrong');
                    this.state.history.push(`>> âš ï¸ è©•ä¼°ä¿®æ­£ï¼š`);
                    feedback.forEach(f => this.state.history.push(`<div class="note-feedback">${f}</div>`));
                    if(this.state.case.assessments.gcs_exp) {
                        this.state.history.push(`<div class="note-feedback">ğŸ’¡ è§£æï¼š${this.state.case.assessments.gcs_exp}</div>`);
                    }
                }
                
                this.state.gcsChecked = true;
                this.renderPhase(this.state.phaseKey);
            },
            
            getCriticalReason: function() {
                const c = this.state.case;
                let reasons = [];
                if(c.assessments.gcs.e + c.assessments.gcs.v + c.assessments.gcs.m < 14) reasons.push("GCS<14");
                if(c.start_phase.includes('amp')) reasons.push("å¤§å‡ºè¡€/æˆªè‚¢");
                if(c.start_phase.includes('shock')) reasons.push("ä¼‘å…‹å¾µè±¡");
                if(c.start_phase.includes('airway')) reasons.push("å‘¼å¸é“é˜»å¡");
                return reasons.join(", ");
            },

            renderPhase: function(phaseKey) {
                this.state.phaseKey = phaseKey;
                const c = this.state.case;
                const container = document.getElementById('app-container');
                
                let logic;
                try {
                    logic = this.getPhaseLogic(phaseKey, c);
                } catch (e) {
                    logic = { text: "Logic Error: " + e.message, options: [{text:"Reset", next:'done'}] };
                }

                const isCrisis = this.state.isCrisisActive;
                const showGCS = (this.state.investigated.voice || this.state.investigated.pain) && !this.state.gcsChecked && !logic.end && !isCrisis;
                const gcs = this.state.gcsInput;
                const gcsTotal = gcs.e + gcs.v + gcs.m;

                let html = `
                    <div class="file-folder ${isCrisis ? 'crisis-mode' : ''}">
                        <div class="file-header">
                            <span class="case-id">CASE: ${c.id}</span>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <div class="crisis-badge" style="display:${isCrisis?'block':'none'}">âš ï¸ CRISIS</div>
                                <div class="stamp-box ${this.state.investigated.voice ? 'assessed' : ''}">
                                    ${this.state.investigated.voice ? 'ASSESSED' : 'PENDING'}
                                </div>
                            </div>
                        </div>
                        <div class="file-body">
                            <div class="crisis-overlay-msg">
                                ğŸš¨ çªç™¼ç‹€æ³ï¼è«‹ç«‹å³è™•ç½®ï¼
                            </div>
                            <div class="polaroid">
                                <img src="${c.img}" alt="Scene">
                                <div class="polaroid-caption">${c.impression}</div>
                            </div>

                            <div class="notebook-log" id="notebook">
                                ${this.state.history.map(h => {
                                    let content = h.replace(/\*\*(.*?)\*\*/g, '<span class="note-highlight">$1</span>');
                                    let cls = h.includes('âš ï¸') || h.includes('âŒ') ? 'note-crisis' : 'note-entry';
                                    return `<div class="${cls}">${content}</div>`;
                                }).join('')}
                            </div>

                            ${!logic.end && !isCrisis ? `
                            <div style="font-size:0.8rem; color:#888; margin-bottom:5px; text-transform:uppercase;">Primary Survey Tools:</div>
                            <div class="investigation-grid">
                                <button class="btn-investigate ${this.state.investigated.voice?'checked':''}" onclick="app.investigate('voice')" ${this.state.investigated.voice?'disabled':''}>
                                    <span>ğŸ—£ï¸</span> æ„è­˜(æŒ‡ä»¤)
                                </button>
                                <button class="btn-investigate ${this.state.investigated.pain?'checked':''}" onclick="app.investigate('pain')" ${this.state.investigated.pain?'disabled':''}>
                                    <span>âš¡ï¸</span> ç—›è¦º(å‹•ä½œ)
                                </button>
                                <button class="btn-investigate ${this.state.investigated.breathing?'checked':''}" onclick="app.investigate('breathing')" ${this.state.investigated.breathing?'disabled':''}>
                                    <span>ğŸ«</span> å‘¼å¸(çœ‹)
                                </button>
                                <button class="btn-investigate ${this.state.investigated.pulse?'checked':''}" onclick="app.investigate('pulse')" ${this.state.investigated.pulse?'disabled':''}>
                                    <span>â¤ï¸</span> å¾ªç’°(æ‘¸)
                                </button>
                            </div>
                            
                            <!-- Detailed GCS Calculator -->
                            <div class="gcs-panel ${showGCS ? 'active' : ''}">
                                <div style="font-weight:bold; margin-bottom:10px; color:var(--primary);">GCS æ˜è¿·æŒ‡æ•¸è©•ä¼°è¡¨</div>
                                
                                <div class="gcs-row">
                                    <span class="gcs-label">Eyes (E) - çœçœ¼åæ‡‰</span>
                                    <div class="gcs-btn-group">
                                        ${[1,2,3,4].map(v => `<button class="gcs-btn ${gcs.e===v?'selected':''}" onclick="app.setGCS('e', ${v})">${v}</button>`).join('')}
                                    </div>
                                </div>
                                
                                <div class="gcs-row">
                                    <span class="gcs-label">Verbal (V) - èªè¨€åæ‡‰</span>
                                    <div class="gcs-btn-group">
                                        ${[1,2,3,4,5].map(v => `<button class="gcs-btn ${gcs.v===v?'selected':''}" onclick="app.setGCS('v', ${v})">${v}</button>`).join('')}
                                    </div>
                                </div>
                                
                                <div class="gcs-row">
                                    <span class="gcs-label">Motor (M) - é‹å‹•åæ‡‰</span>
                                    <div class="gcs-btn-group">
                                        ${[1,2,3,4,5,6].map(v => `<button class="gcs-btn ${gcs.m===v?'selected':''}" onclick="app.setGCS('m', ${v})">${v}</button>`).join('')}
                                    </div>
                                </div>

                                <div class="gcs-summary">
                                    E${gcs.e || '_'} + V${gcs.v || '_'} + M${gcs.m || '_'} = GCS ${gcsTotal} åˆ†
                                </div>

                                <div class="gcs-critical-check">
                                    <div style="font-size:0.9rem; margin-bottom:5px; width:100%;">ç¬¦åˆ ALS å±æ€¥å€‹æ¡ˆæ¨™æº–ï¼Ÿ<br><small>(åŒ…å«GCS<14ã€ä¼‘å…‹ã€å¤§å‡ºè¡€ç­‰)</small></div>
                                    <button class="gcs-btn ${gcs.critical===true?'selected':''}" style="border-color:var(--crisis);" onclick="app.setGCSCritical(true)">æ˜¯ (Yes)</button>
                                    <button class="gcs-btn ${gcs.critical===false?'selected':''}" style="border-color:var(--success);" onclick="app.setGCSCritical(false)">å¦ (No)</button>
                                </div>

                                <button class="gcs-confirm-btn" onclick="app.submitGCS()">ç¢ºèªæäº¤è©•ä¼°</button>
                            </div>
                            
                            ` : ''}

                            <div class="action-area">
                                <div class="question-text" style="${isCrisis?'color:var(--crisis)':''}">${logic.text}</div>
                                ${logic.options.map((opt, i) => `
                                    <button class="btn-decision ${isCrisis?'crisis-btn':''}" onclick="app.handleAction(${i})">
                                        ${opt.text}
                                    </button>
                                `).join('')}
                                
                                ${!logic.end ? `
                                <div class="hint-toggle" onclick="this.nextElementSibling.style.display='block'">ğŸ’¡ æ•™å®˜æç¤º (Hint)</div>
                                <div class="hint-content">${logic.hint || "è«‹å…ˆå®Œæ•´è©•ä¼° XABCã€‚"}</div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;

                container.innerHTML = html;
                const notebook = document.getElementById('notebook');
                if(notebook) notebook.scrollTop = notebook.scrollHeight;
            },

            handleAction: function(idx) {
                const logic = this.getPhaseLogic(this.state.phaseKey, this.state.case);
                const opt = logic.options[idx];
                
                document.querySelectorAll('.btn-decision').forEach(b => b.disabled = true);
                this.state.history.push(`>> æ±ºç­–: ${opt.text}`);
                
                let next = opt.next;
                if(typeof next === 'function') next = next();

                // Crisis Injection (Randomly Triggered)
                // Trigger logic: Not ending, not in crisis, low chance (15%), or specific scenarios forcing it
                if (!next.includes('success') && !next.includes('fail') && !next.includes('done') && !this.state.isCrisisActive && Math.random() < 0.15) {
                    const crisisRoll = Math.random();
                    if (crisisRoll > 0.5) {
                        next = 'phase_crisis_air_raid';
                        this.state.isCrisisActive = true;
                        audioSys.playTone('crisis');
                    } else if (this.state.case.type === 'Green' || this.state.case.type === 'Yellow') {
                        next = 'phase_crisis_deteriorate';
                        this.state.isCrisisActive = true;
                        audioSys.playTone('crisis');
                    }
                }

                if (this.state.phaseKey.includes('crisis') && !next.includes('crisis')) {
                    this.state.isCrisisActive = false;
                }

                if(next.includes('success')) {
                    document.querySelectorAll('.btn-decision')[idx].classList.add('correct');
                    audioSys.playTone('correct');
                    this.state.history.push(`>> âœ… è™•ç½®æ­£ç¢º`);
                } else if (next.includes('fail')) {
                    document.querySelectorAll('.btn-decision')[idx].classList.add('wrong');
                    audioSys.playTone('wrong');
                    this.state.history.push(`>> âŒ ${opt.feedback || "è™•ç½®ä¸ç•¶"}`);
                } else if (next === 'x_treated_ok') {
                    this.state.x_treated = true;
                    this.state.history.push(`>> âœ… æ­¢è¡€å¸¶å·²å›ºå®šã€‚å¤§å‡ºè¡€åœæ­¢ã€‚`);
                    // Redirect back to generic start to continue ABC
                    next = this.state.case.start_phase; 
                }

                setTimeout(() => {
                    if(next === 'done') this.startRoulette();
                    else this.renderPhase(next);
                }, 1500);
            },

            // --- Logic Router ---
            getPhaseLogic: function(key, c) {
                // 1. STARTS
                if(key.startsWith('start_')) {
                    // Check for X (Massive Bleed)
                    const hasX = key.includes('amp');
                    
                    if (hasX && !this.state.x_treated) {
                        return {
                            text: "ğŸš¨ å‚·æ‚£æœ‰å™´å°„ç‹€å¤§å‡ºè¡€ (X)ï¼ä½ çš„é¦–è¦è™•ç½®ï¼Ÿ",
                            hint: "XABCDE åŸå‰‡ï¼šå¤§å‡ºè¡€å„ªå…ˆæ–¼å‘¼å¸é“èˆ‡æ„è­˜è©•ä¼°ã€‚",
                            options: [
                                { text: "ç«‹å³ä½¿ç”¨æ­¢è¡€å¸¶ (Tourniquet)", next: 'x_treated_ok' },
                                { text: "è©•ä¼°æ„è­˜ (GCS)", next: 'phase_fail_x_delay', feedback: "éŒ¯èª¤ï¼å¤§å‡ºè¡€æ‡‰å„ªå…ˆæ­¢è¡€ï¼Œè©•ä¼°æ„è­˜æœƒå»¶èª¤æ•‘å‘½ã€‚" },
                                { text: "æš¢é€šå‘¼å¸é“", next: 'phase_fail_x_delay', feedback: "éŒ¯èª¤ï¼å¤§å‡ºè¡€å„ªå…ˆç´šé«˜æ–¼ Aã€‚" }
                            ]
                        };
                    }

                    return {
                        text: "å‡ºè¡€å·²æ§åˆ¶/ç„¡æ˜é¡¯å¤§å‡ºè¡€ã€‚æŒ‡æ®å®˜ï¼Œè«‹ä¸‹é”æŒ‡ä»¤ï¼š",
                        hint: "é€²è¡Œåˆç´šè©•ä¼° ABCã€‚ç¢ºèªæ„è­˜ã€å‘¼å¸ã€å¾ªç’°ã€‚",
                        options: [
                            key.includes('black') ? { text: "åˆ¤å®šé»‘ç‰Œ (é¡¯ç„¶æ­»äº¡)ï¼Œè·³é", next: 'phase_success_black' } : null,
                            
                            (key.includes('airway') || key.includes('airway_snore')) ? { text: "å‘¼å¸é“é˜»å¡ï¼šæ”¾ç½® OPA/NPA", next: 'phase_success_airway' } : null,
                            key.includes('airway') ? { text: "å˜—è©¦æ’ç®¡ (Intubation)", next: 'phase_fail_scope', feedback: "è¶Šæ¬Šè™•ç½®ï¼" } : null,
                            
                            key.includes('crush') ? { text: "å£“ç ¸å‚·ï¼šç´…ç‰Œï¼Œå„˜é€Ÿå¾Œé€", next: 'phase_success_crush' } : null,
                            key.includes('shock') ? { text: "ä¼‘å…‹å¾µè±¡ï¼šç´…ç‰Œï¼Œä¿æš–/çµ¦æ°§/å¾Œé€", next: 'phase_success_shock' } : null,
                            key.includes('pneumo') ? { text: "æ°£èƒ¸å¾µè±¡ï¼šç´…ç‰Œï¼Œçµ¦æ°§/é€šçŸ¥é†«é™¢", next: 'phase_success_load_go' } : null,
                            
                            key.includes('fracture') ? { text: "é»ƒç‰Œï¼šå›ºå®šéª¨æŠ˜ï¼Œç¨å¾Œå¾Œé€", next: 'phase_success_splint' } : null,
                            key.includes('green') ? { text: "ç¶ ç‰Œï¼šæŒ‡å¼•è‡³å®‰å…¨å€", next: 'phase_success_green' } : null,
                            
                            // If X was treated, allow finish
                            this.state.x_treated ? { text: "å®Œæˆåˆæ­¥è™•ç½®ï¼Œæº–å‚™å¾Œé€", next: 'phase_success_tq_done' } : null,

                            { text: "å°šæœªè©•ä¼°æ¸…æ¥šï¼Œç¹¼çºŒè§€å¯Ÿ", next: key }
                        ].filter(Boolean)
                    };
                }

                if(key === 'phase_crisis_air_raid') {
                    return {
                        text: "ğŸš¨ çªç™¼ç‹€æ³ï¼šç©ºè¥²è­¦å ±éŸ¿èµ·ï¼",
                        options: [
                            { text: "ç¹¼çºŒè©•ä¼°", next: 'phase_fail_danger', feedback: "ç„¡è¦–ç¾å ´å®‰å…¨ï¼Œæœæ•‘äººå“¡é™£äº¡ã€‚" },
                            { text: "ç«‹å³å°‹æ‰¾æ©è­· (Take Cover)", next: c.start_phase || 'start_generic' }
                        ]
                    };
                }
                if(key === 'phase_crisis_deteriorate') {
                    return {
                        text: "ğŸš¨ çªç™¼ç‹€æ³ï¼šå‚·æ‚£çªç„¶å€’åœ°æŠ½æ (ç™²ç™‡/ä¼‘å…‹)ï¼",
                        options: [
                            { text: "é‡æ–°è©•ä¼° ABC", next: 'phase_success_reassess' },
                            { text: "ä¸äºˆç†æœƒ", next: 'phase_fail_neglect', feedback: "å¿½è¦–ç—…æƒ…è®ŠåŒ–å°è‡´æ­»äº¡ã€‚" }
                        ]
                    };
                }

                switch(key) {
                    case 'phase_success_black': return this.end("æª¢å‚·å®Œæˆ", "æ­£ç¢ºåˆ¤å®šé»‘ç‰Œï¼Œä¿ç•™è³‡æºã€‚");
                    case 'phase_success_tq_done': return this.end("è™•ç½®æˆåŠŸ", "æ­¢è¡€å¸¶æˆåŠŸæ­¢ä½å‹•è„ˆå‡ºè¡€ï¼Œå‚·æ‚£å­˜æ´»ã€‚");
                    case 'phase_fail_bleed': return this.end("å‚·æ‚£æ­»äº¡", "æ­¢è¡€å¤±æ•—å°è‡´å¤±è¡€æ€§ä¼‘å…‹ã€‚", false);
                    case 'phase_fail_x_delay': return this.end("å‚·æ‚£æ­»äº¡", "æœªå„ªå…ˆè™•ç†å¤§å‡ºè¡€ (X)ï¼Œå°è‡´å¤±è¡€éå¤šã€‚", false);
                    case 'phase_success_airway': return this.end("è™•ç½®æˆåŠŸ", "å‘¼å¸é“æš¢é€šï¼ŒSpO2 ä¸Šå‡ã€‚");
                    case 'phase_fail_scope': return this.end("æ¼”ç·´ä¸­æ­¢", "EMT-1 ç¦æ­¢åŸ·è¡Œé«˜ç´šå‘¼å¸é“è™•ç½®ã€‚", false);
                    case 'phase_success_splint': return this.end("è™•ç½®æˆåŠŸ", "éª¨æŠ˜å·²å›ºå®šï¼Œç—›æ„Ÿæ¸›è¼•ã€‚");
                    case 'phase_success_green': return this.end("åˆ†æµæ­£ç¢º", "å‚·æ‚£å·²è‡ªè¡Œç§»å‹•è‡³ç¶ å€ã€‚");
                    case 'phase_success_crush': return this.end("è™•ç½®æ­£ç¢º", "å£“ç ¸å‚·éœ€å¿«é€Ÿå¾Œé€é¿å…è…”å®¤ç—‡å€™ç¾¤ã€‚");
                    case 'phase_success_shock': return this.end("è™•ç½®æ­£ç¢º", "ä¼‘å…‹è™•ç½®å¾—å®œã€‚");
                    case 'phase_success_load_go': return this.end("è™•ç½®æ­£ç¢º", "å±æ€¥å€‹æ¡ˆå¿«é€Ÿå¾Œé€ã€‚");
                    case 'phase_fail_danger': return this.end("æ¼”ç·´å¤±æ•—", "ç¾å ´å®‰å…¨æœªç¢ºèªã€‚", false);
                    case 'phase_success_reassess': return this.end("å±æ©Ÿè§£é™¤", "æˆåŠŸè¾¨è­˜ç—…æƒ…è®ŠåŒ–ã€‚");
                    case 'phase_fail_neglect': return this.end("æ¼”ç·´å¤±æ•—", "å¿½è¦–å‚·æ‚£ç—…æƒ…è®ŠåŒ–ã€‚", false);
                    
                    default: return { text: "Error: Unknown Phase", options: [{text:"Reset", next:'done'}]};
                }
            },

            end: function(title, sub, success=true) {
                return {
                    text: `${title}ï¼š${sub}`,
                    end: true,
                    options: [{ text: "çµæ¡ˆ (Next Case)", next: 'done' }]
                };
            },

            // --- Review Mode ---
            renderReview: function() {
                const container = document.getElementById('app-container');
                const REVIEW_QUIZ = [
                    { q: "PHTLS è©•ä¼°æµç¨‹ä¸­ï¼Œè‹¥ç™¼ç¾å‚·æ‚£æœ‰å™´å°„ç‹€å‡ºè¡€ï¼Œæ‡‰å„ªå…ˆè™•ç†å“ªä¸€å€‹æ­¥é©Ÿï¼Ÿ", opts:["A (Airway)","B (Breathing)","C (Circulation)","X (Exsanguinating Hemorrhage)"], ans:3, exp:"XABCDE åŸå‰‡ä¸­ï¼Œå±åŠç”Ÿå‘½çš„å¤§å‡ºè¡€ (X) å¿…é ˆæœ€å„ªå…ˆè™•ç†ï¼Œç”šè‡³å…ˆæ–¼å‘¼å¸é“ã€‚" },
                    { q: "GCS 15 åˆ†çš„å‚·æ‚£ï¼Œæ˜¯å¦å¯èƒ½ç‚ºå±æ€¥å€‹æ¡ˆ (ALS)ï¼Ÿ", opts:["ä¸å¯èƒ½","å¯èƒ½"], ans:1, exp:"å¯èƒ½ã€‚ä¾‹å¦‚å‰µå‚·æˆªè‚¢ã€ä»£å„Ÿæ€§ä¼‘å…‹åˆæœŸï¼Œé›–ç„¶æ„è­˜æ¸…æ¥š (GCS 15)ï¼Œä½†ä»å±¬æ–¼å±æ€¥å€‹æ¡ˆã€‚" }
                ];
                
                let html = `<div class="file-folder"><div class="file-header">REVIEW QUIZ</div><div class="file-body">`;
                REVIEW_QUIZ.forEach((q, i) => {
                    html += `<div class="quiz-card"><div class="question-text">Q${i+1}: ${q.q}</div>`;
                    q.opts.forEach((o, oid) => {
                        html += `<button class="btn-decision" onclick="app.checkReview(this, ${oid===q.ans}, '${q.exp}')">${o}</button>`;
                    });
                    html += `<div class="hint-content"></div></div>`;
                });
                html += `</div></div>`;
                container.innerHTML = html;
            },
            
            checkReview: function(btn, correct, exp) {
                const fb = btn.parentElement.querySelector('.hint-content');
                fb.style.display = 'block';
                if(correct) {
                    btn.classList.add('correct');
                    fb.innerHTML = `âœ… æ­£ç¢ºï¼ ${exp}`;
                } else {
                    btn.classList.add('wrong');
                    fb.innerHTML = `âŒ éŒ¯èª¤ã€‚ ${exp}`;
                }
            }
        };

        /* =========================================
           3. AUDIO System
           ========================================= */
        const audioSys = {
            isMuted: false,
            ctx: null,
            init: function() { 
                if(!this.ctx) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if(AudioContext) this.ctx = new AudioContext();
                }
            },
            toggleMute: function() { 
                this.isMuted = !this.isMuted; 
                document.getElementById('mute-toggle').classList.toggle('active');
                if(!this.isMuted && this.ctx && this.ctx.state === 'suspended') this.ctx.resume();
            },
            playTone: function(type) {
                if(this.isMuted || !this.ctx) return;
                const o = this.ctx.createOscillator(); 
                const g = this.ctx.createGain();
                o.connect(g); g.connect(this.ctx.destination);
                
                const t = this.ctx.currentTime;
                if(type==='correct') { 
                    o.frequency.setValueAtTime(600, t);
                    o.frequency.exponentialRampToValueAtTime(1000, t+0.1);
                    g.gain.setValueAtTime(0.1, t);
                    g.gain.linearRampToValueAtTime(0, t+0.2);
                    o.start(t); o.stop(t+0.2);
                } else if(type==='crisis') {
                    o.type='square';
                    o.frequency.setValueAtTime(400, t);
                    o.frequency.linearRampToValueAtTime(200, t+0.5);
                    g.gain.setValueAtTime(0.2, t);
                    g.gain.linearRampToValueAtTime(0, t+0.5);
                    o.start(t); o.stop(t+0.5);
                } else { 
                    o.type='sawtooth'; 
                    o.frequency.setValueAtTime(150, t);
                    g.gain.setValueAtTime(0.1, t);
                    g.gain.linearRampToValueAtTime(0, t+0.3);
                    o.start(t); o.stop(t+0.3);
                }
            }
        };

    </script>
</body>
</html>