<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>EMT-1 æˆ°è¡“å…µæ¨ V28 | è¡Œå‹•é©é…ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* --- 1. Design System --- */
        :root {
            --bg-color: #E6E2D8; 
            --paper-color: #FDFBF7;
            --text-main: #2F2F2F; 
            --text-sub: #666;  
            --primary: #2C3E50;
            --accent: #C0392B;    /* Critical Red */
            --success: #27AE60;   /* Green */
            --warning: #F39C12;
            --black: #2C3E50;
            
            --radius: 6px;
            --border: 1px solid #C0B7A8;
            --shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            /* Dynamic Viewport Height for Mobile Browsers */
            height: 100dvh; 
            width: 100vw;
            display: flex; flex-direction: column;
            overflow: hidden; 
        }

        /* --- Header --- */
        header {
            padding: 10px 16px; background: #F4F3EF; border-bottom: 2px solid #aaa;
            display: flex; justify-content: space-between; align-items: center; z-index: 20;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            height: 50px; flex-shrink: 0;
            padding-top: env(safe-area-inset-top); /* Notch support */
        }
        h1 { font-size: 1rem; font-weight: 700; margin: 0; color: var(--primary); letter-spacing: 1px; }
        
        .mute-btn { border: 1px solid #999; color: #555; padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; background:none; cursor: pointer; }
        .mute-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }

        /* --- Main Layout --- */
        main {
            flex: 1; overflow: hidden; position: relative;
            display: flex; flex-direction: column;
            /* Ensure bottom content isn't hidden by home bar */
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* --- 0. START SCREEN --- */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(230, 226, 216, 0.98); z-index: 600;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 20px;
        }
        .mission-card {
            background: #fff; border: 1px solid #999; padding: 25px; max-width: 400px; width: 100%;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); border-radius: 8px;
        }
        .btn-start {
            margin-top: 20px; padding: 15px 40px; background: var(--primary); color: #fff;
            border: none; font-size: 1.2rem; cursor: pointer; border-radius: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); font-weight: bold;
        }

        /* --- 1. SCENE MAP VIEW --- */
        #scene-view {
            width: 100%; height: 100%; position: absolute; top: 0; left: 0;
            background: #EAECEE; overflow: hidden;
            display: none; /* Toggled */
        }
        .map-grid {
            width: 100%; height: 100%; position: relative;
            background-color: #D6DBDF;
            background-image: 
                linear-gradient(rgba(255,255,255,0.3) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.3) 1px, transparent 1px);
            background-size: 40px 40px;
            overflow: hidden; 
        }
        .map-obj { position: absolute; font-size: 0.8rem; color: #555; pointer-events: none; text-align: center; font-weight: bold; border: 2px dashed #999; display:flex; align-items:center; justify-content:center; opacity:0.5; background: rgba(255,255,255,0.2); }
        .map-obj.zone-a { top: 5%; left: 5%; width: 40%; height: 35%; }
        .map-obj.zone-b { top: 50%; left: 50%; width: 45%; height: 45%; }
        .map-obj.zone-c { top: 70%; left: 5%; width: 35%; height: 25%; }
        
        .patient-dot {
            width: 40px; height: 40px; background: #7F8C8D; border: 2px solid #fff;
            border-radius: 50%; position: absolute; cursor: pointer;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: #fff; font-size: 0.8rem;
            transition: transform 0.2s; z-index: 10;
            /* Ensure touch targets are big enough */
            touch-action: manipulation;
        }
        .patient-dot:active { transform: scale(1.4); }
        /* Tag Colors */
        .patient-dot.done-Red { background: #C0392B; opacity: 0.9; }
        .patient-dot.done-Yellow { background: #F1C40F; opacity: 0.9; color: #333; }
        .patient-dot.done-Green { background: #27AE60; opacity: 0.9; }
        .patient-dot.done-Black { background: #2C3E50; opacity: 0.9; }
        
        .patient-dot.green-walk { animation: walkAway 1s forwards; }
        @keyframes walkAway { to { opacity: 0; transform: translate(100px, -100px); } }

        .broadcast-btn {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            background: var(--success); color: white; border: none; padding: 12px 24px;
            font-size: 1rem; border-radius: 30px; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); font-weight: bold; display: flex; gap: 8px; align-items: center;
            z-index: 30; white-space: nowrap;
            /* Avoid bottom bar intersection */
            margin-bottom: env(safe-area-inset-bottom);
        }
        .broadcast-btn:disabled { background: #999; cursor: default; opacity: 0.7; }

        /* Floating Dashboard */
        #dashboard {
            position: fixed; top: 60px; left: 10px; width: 160px;
            background: rgba(255,255,255,0.98); border: 1px solid #555;
            border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); 
            z-index: 1000; /* Highest z-index to float over report modal */
            transition: height 0.3s, opacity 0.3s; 
            display: none; /* Hidden initially */
            overflow: hidden;
        }
        .dash-header {
            background: var(--primary); color: white; padding: 10px; cursor: move;
            font-size: 0.85rem; font-weight: bold; display: flex; justify-content: space-between; align-items: center;
            touch-action: none; /* Essential for drag */
        }
        .dash-btn { background: none; border: none; color: white; font-weight: bold; cursor: pointer; padding: 5px 10px; font-size: 1.2rem; line-height: 0.5; }
        .dash-content { padding: 10px; font-size: 0.9rem; }
        .dash-row { display: flex; justify-content: space-between; margin-bottom: 6px; border-bottom: 1px dotted #ccc; padding-bottom: 2px;}
        .dash-content.collapsed { display: none; }

        /* Mission Timer */
        #mission-timer {
            position: absolute; top: 10px; right: 10px;
            background: #333; color: #0f0; font-family: 'Roboto Mono', monospace;
            font-size: 1.2rem; padding: 6px 12px; border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); border: 2px solid #555;
            z-index: 40; pointer-events: none;
        }
        #mission-timer.urgent { color: #e74c3c; animation: pulse-red 1s infinite; border-color: #e74c3c; }

        /* --- 2. PATIENT VIEW --- */
        #patient-view {
            width: 100%; height: 100%; position: absolute; top: 0; left: 0;
            background: var(--paper-color); display: none; flex-direction: column;
        }
        
        .pv-header { 
            padding: 8px 12px; background: #fff; border-bottom: 1px solid #ccc; 
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
        }
        .pv-body { flex: 1; display: flex; overflow: hidden; position: relative; }
        
        /* RWD: Flex Direction change on mobile */
        @media (max-width: 768px) {
            .pv-body { flex-direction: column; }
            .body-container { height: 45%; border-right: none; border-bottom: 1px solid #ddd; flex-shrink: 0; }
            .info-panel { height: 55%; max-width: 100%; padding-bottom: 80px; /* Space for triage buttons */ }
        }

        .body-container {
            flex: 1; position: relative; background: #FDFBF7;
            display: flex; align-items: center; justify-content: center;
            border-right: 1px solid #ddd; padding: 10px; overflow: hidden;
        }
        svg.body-svg { height: 100%; width: auto; max-width: 100%; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1)); touch-action: manipulation; }
        
        .body-part { fill: #E0E0E0; stroke: #999; stroke-width: 1.5; transition: fill 0.2s; cursor: pointer; }
        .body-part:active { fill: #D6DBDF; } /* Touch feedback */
        .body-part.assessed { fill: #A9DFBF; stroke: #196F3D; }
        .body-part.injured { fill: #F5B7B1; stroke: #C0392B; }
        .body-part.critical-x { animation: pulse-red 0.8s infinite; fill: #E74C3C; }

        .finding-label {
            position: absolute; background: rgba(255,255,255,0.95); border: 1px solid #333;
            padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; pointer-events: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); max-width: 180px; text-align: center;
            animation: popIn 0.3s; font-weight: 500; z-index: 20;
        }

        .info-panel {
            flex: 1; padding: 15px; overflow-y: auto; background: #fff;
            max-width: 400px; border-left: 1px solid #ccc;
            display: flex; flex-direction: column;
            /* Ensure content isn't blocked at bottom */
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
        }

        .assessment-log {
            flex: 1; border: 1px solid #ccc; background: #FAFAFA; padding: 10px;
            margin-bottom: 10px; overflow-y: auto; font-family: 'Courier New', monospace;
            font-size: 0.9rem; line-height: 1.5; min-height: 100px;
        }
        .log-entry { margin-bottom: 6px; border-left: 3px solid transparent; padding-left: 6px; }
        .log-entry.warn { border-left-color: #C0392B; background: #FDEDEC; color: #922B21; }
        .log-entry.action { border-left-color: var(--primary); font-weight: bold; }
        .log-entry.death { border-left-color: #000; background: #333; color: #fff; }

        .action-grid { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
        .btn-action {
            padding: 12px; background: #fff; border: 1px solid #999; border-radius: 4px;
            text-align: left; cursor: pointer; transition: all 0.1s;
            font-size: 0.95rem; display: flex; justify-content: space-between; align-items: center;
            /* Mobile touch target */
            min-height: 48px;
        }
        .btn-action:active { background: #f0f4f8; transform: scale(0.98); }
        .btn-action:disabled { opacity: 0.5; cursor: not-allowed; background: #eee; }
        .btn-action.priority { border: 2px solid var(--accent); color: var(--accent); background: #FDEDEC; font-weight: bold; }

        .triage-row { 
            display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; 
            margin-top: auto; padding-top: 10px; border-top: 1px dashed #ccc; 
            /* Ensure it stays at bottom but safe from home bar */
            padding-bottom: env(safe-area-inset-bottom);
        }
        .btn-triage {
            padding: 12px 0; color: white; border: none; border-radius: 4px;
            font-weight: bold; cursor: pointer; font-size: 0.9rem;
        }
        .btn-triage:active { opacity: 0.8; }
        .btn-triage.red { background: #C0392B; }
        .btn-triage.yellow { background: #F1C40F; color: #333; }
        .btn-triage.green { background: #27AE60; }
        .btn-triage.black { background: #2C3E50; }

        /* Overlays & Modals */
        #crisis-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(192, 57, 43, 0.95); z-index: 550;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            animation: flash 0.5s infinite alternate; text-align: center; padding: 20px;
        }
        .crisis-text { color: #fff; font-size: 2rem; font-weight: bold; margin-bottom: 20px; }
        
        #report-modal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.7); z-index: 600;
            display: none; justify-content: center; align-items: center; padding: 20px;
        }
        .report-card { 
            background: white; padding: 20px; border-radius: 8px; width: 100%; max-width: 360px; 
            position:relative; box-shadow: 0 5px 20px rgba(0,0,0,0.3); 
            /* Ensure it fits in viewport */
            max-height: 80vh; overflow-y: auto;
        }
        .report-input { width: 60px; padding: 8px; text-align: center; margin-left: 10px; font-size: 1.2rem; border: 1px solid #ccc; border-radius: 4px; }
        .report-row { margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 1.1rem; }

        #feedback-modal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.6); z-index: 550;
            display: none; justify-content: center; align-items: center; padding: 20px;
        }
        .feedback-content {
            background: #fff; padding: 20px; border-radius: 8px; max-width: 320px; width: 100%;
            text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); border: 3px solid #C0392B;
        }

        #ending-modal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(255,255,255,0.98); z-index: 700;
            display: none; flex-direction: column; align-items: center;
            padding: 20px; overflow-y: auto;
        }
        .ending-content { max-width: 600px; width:100%; background: white; border: 1px solid #333; padding: 20px; margin: 20px 0; }

        #bleed-timer {
            position: absolute; top: 10px; right: 70px;
            background: #C0392B; color: white; padding: 4px 8px;
            font-weight: bold; font-family: monospace; border-radius: 4px;
            display: none; animation: pulse-red 1s infinite; font-size: 0.9rem;
        }

        @keyframes pulse-red { 0% { fill: #E74C3C; opacity: 1; } 50% { fill: #F1948A; opacity: 0.5; } 100% { fill: #E74C3C; opacity: 1; } }
        @keyframes flash { from { opacity: 0.95; } to { opacity: 0.85; } }
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    </style>
</head>
<body>

    <!-- Floating Dashboard (Draggable & High Z-Index) -->
    <div id="dashboard">
        <div class="dash-header" id="dash-header">
            <span>ğŸ“Š æˆ°æƒ…çœ‹æ¿</span>
            <button class="dash-btn" onclick="app.toggleDash()">_</button>
        </div>
        <div id="dash-content" class="dash-content">
            <div class="dash-row"><span style="color:#C0392B">ğŸ”´ Red</span><span id="count-r" style="font-weight:bold">0</span></div>
            <div class="dash-row"><span style="color:#F39C12">ğŸŸ¡ Yellow</span><span id="count-y" style="font-weight:bold">0</span></div>
            <div class="dash-row"><span style="color:#27AE60">ğŸŸ¢ Green</span><span id="count-g" style="font-weight:bold">0</span></div>
            <div class="dash-row"><span style="color:#2C3E50">âš« Black</span><span id="count-b" style="font-weight:bold">0</span></div>
            <div style="margin-top:5px; padding-top:2px; font-size:0.8rem; color:#666;">
                å¾…è™•ç†: <span id="pending-count">15</span>
            </div>
        </div>
    </div>

    <!-- 0. Start Screen -->
    <div id="start-screen">
        <div class="mission-card">
            <h1 style="font-size:1.5rem; margin-bottom:15px; color:var(--primary);">MCI æˆ°è¡“æ¼”ç·´å…µæ¨</h1>
            <p style="color:#666; margin-bottom:20px; line-height:1.6; text-align:left;">
                <strong>ä»»å‹™ä»£è™Ÿï¼š</strong> 1130 ç©ºè¥²äº‹ä»¶<br>
                <strong>å‚·æ‚£ç¸½æ•¸ï¼š</strong> 15 å<br>
                <strong>ä»»å‹™æ™‚é™ï¼š</strong> 10 åˆ†é˜<br>
                <strong>ä»»å‹™ç›®æ¨™ï¼š</strong><br>
                1. ç¾å ´æŒ‡æ® (Scene Command)<br>
                2. å¿«é€Ÿæª¢å‚· (START Triage)<br>
                3. åˆæ­¥è™•ç½® (Life-saving Interventions)<br>
                4. å›å ±æŒ‡æ®ä¸­å¿ƒ (Report)<br>
                <br>
                <small style="color:var(--accent)">âš ï¸ æ³¨æ„ï¼šç©ºè¥²æœƒå°è‡´æœªè™•ç½®çš„å¤§å‡ºè¡€å‚·æ‚£ç«‹å³æ­»äº¡ã€‚</small>
            </p>
            <button class="btn-start" onclick="app.startMission()">é–‹å§‹ä»»å‹™ Start</button>
        </div>
    </div>

    <!-- Crisis Overlay -->
    <div id="crisis-overlay">
        <div class="crisis-text">ğŸš¨ ç©ºè¥²è­¦å ± AIR RAID ğŸš¨</div>
        <div style="color:white; margin-bottom:30px; font-size:1.2rem;">ç ²å½ˆä¾†è¥²ï¼ç«‹å³å°‹æ‰¾æ©è­·ï¼</div>
        <button class="btn-action" style="width:auto; justify-content:center; font-weight:bold; font-size:1.2rem; padding:15px 30px;" onclick="app.resolveCrisis()">ğŸ›¡ï¸ å°‹æ‰¾æ©è­· (Take Cover)</button>
    </div>

    <!-- Feedback Modal -->
    <div id="feedback-modal">
        <div class="feedback-content">
            <h3 style="color:#C0392B; margin-top:0;">æª¢å‚·åˆ¤æ–·éŒ¯èª¤</h3>
            <p id="feedback-text" style="color:#555; margin:15px 0; text-align:left; line-height:1.5;">...</p>
            <button onclick="document.getElementById('feedback-modal').style.display='none'" style="padding:10px 30px; font-size:1rem; cursor:pointer; background:var(--primary); color:white; border:none; border-radius:6px;">ç¢ºèª</button>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="report-modal">
        <div class="report-card">
            <h2 style="text-align:center; color:var(--primary); margin-bottom:10px;">æŒ‡æ®ä¸­å¿ƒå›å ±</h2>
            <p style="text-align:center; color:#666; margin-bottom:15px; font-size:0.85rem;">(è«‹åƒè€ƒæ‡¸æµ®æˆ°æƒ…çœ‹æ¿å¡«å¯«)</p>
            <div class="report-row" style="color:#C0392B;">ğŸ”´ ç´…ç‰Œ (Red): <input type="number" id="rep-r" class="report-input" min="0" inputmode="numeric"></div>
            <div class="report-row" style="color:#F39C12;">ğŸŸ¡ é»ƒç‰Œ (Yellow): <input type="number" id="rep-y" class="report-input" min="0" inputmode="numeric"></div>
            <div class="report-row" style="color:#27AE60;">ğŸŸ¢ ç¶ ç‰Œ (Green): <input type="number" id="rep-g" class="report-input" min="0" inputmode="numeric"></div>
            <div class="report-row" style="color:#2C3E50;">âš« é»‘ç‰Œ (Black): <input type="number" id="rep-b" class="report-input" min="0" inputmode="numeric"></div>
            <button class="btn-action" style="width:100%; justify-content:center; background:var(--primary); color:white; font-weight:bold; margin-top:20px;" onclick="app.submitReport()">ç™¼é€å›å ± (Send)</button>
        </div>
    </div>

    <!-- Ending Modal (AAR) -->
    <div id="ending-modal">
        <div class="ending-content">
            <div id="ending-title" class="ending-title"></div>
            <div id="ending-body" class="ending-body"></div>
            <div style="font-weight:bold; margin-bottom:10px; color:var(--primary);">è©³ç´°æª¢è¨å ±å‘Š (After Action Review):</div>
            <div id="ending-review" class="case-review"></div>
            <button class="btn-action" style="margin-top:20px; justify-content:center; background:var(--primary); color:white;" onclick="location.reload()">é‡æ–°é–‹å§‹è¨“ç·´ (Restart)</button>
        </div>
    </div>

    <!-- Header -->
    <header>
        <h1>EMT-1 SIM V28</h1>
        <button id="mute-toggle" class="mute-btn" onclick="audioSys.toggleMute()">ğŸ”Š éŸ³æ•ˆ</button>
    </header>

    <main>
        <!-- 1. SCENE MAP VIEW -->
        <div id="scene-view">
            <!-- Global Mission Timer -->
            <div id="mission-timer">10:00</div>

            <div class="map-grid" id="map-container">
                <div class="map-obj zone-a">ZONE A (å•†å ´)</div>
                <div class="map-obj zone-b">ZONE B (å…¬è»Š)</div>
                <div class="map-obj zone-c">ZONE C (åœ°ä¸‹å®¤)</div>
            </div>
            
            <button id="btn-broadcast" class="broadcast-btn" onclick="app.broadcastGreen()">
                <span>ğŸ“¢</span> å»£æ’­ï¼šå¯è¡Œèµ°è€…é›†åˆ (Green)
            </button>
        </div>

        <!-- 2. PATIENT VIEW (Body Map) -->
        <div id="patient-view">
            <div class="pv-header">
                <span id="case-title" style="font-weight:bold; font-family:'Roboto Mono';">CASE: ???</span>
                <div id="bleed-timer">60s</div>
                <button onclick="app.returnToScene()" style="padding:6px 12px; border:1px solid #999; background:#fff; cursor:pointer; border-radius:4px;">â†© è¿”å›</button>
            </div>
            
            <div class="pv-body">
                <div class="body-container">
                    <svg class="body-svg" viewBox="0 0 200 450" xmlns="http://www.w3.org/2000/svg">
                        <!-- Clickable Zones with Explicit IDs -->
                        <circle id="part-head" class="body-part" cx="100" cy="50" r="35" onclick="app.assessPart('head')"/>
                        <path id="part-chest" class="body-part" d="M 65 90 L 135 90 L 130 160 L 70 160 Z" onclick="app.assessPart('chest')"/>
                        <path id="part-abdomen" class="body-part" d="M 70 160 L 130 160 L 125 210 L 75 210 Z" onclick="app.assessPart('abdomen')"/>
                        <rect id="part-arm-l" class="body-part" x="25" y="95" width="35" height="110" rx="10" onclick="app.assessPart('arm_l')"/>
                        <rect id="part-arm-r" class="body-part" x="140" y="95" width="35" height="110" rx="10" onclick="app.assessPart('arm_r')"/>
                        <rect id="part-leg-l" class="body-part" x="65" y="215" width="32" height="160" rx="10" onclick="app.assessPart('leg_l')"/>
                        <rect id="part-leg-r" class="body-part" x="103" y="215" width="32" height="160" rx="10" onclick="app.assessPart('leg_r')"/>
                    </svg>
                    <div id="body-overlays"></div>
                </div>

                <div class="info-panel">
                    <div id="log-display" class="assessment-log">
                        <div class="log-entry sys">ç³»çµ±å°±ç·’ã€‚è«‹é»é¸å·¦å´èº«é«”éƒ¨ä½é€²è¡Œè©•ä¼°ã€‚</div>
                    </div>
                    <div id="action-panel" class="action-grid"></div>
                    <div class="triage-row">
                        <button class="btn-triage red" onclick="app.tagPatient('Red')">ç´… Red</button>
                        <button class="btn-triage yellow" onclick="app.tagPatient('Yellow')">é»ƒ Yellow</button>
                        <button class="btn-triage green" onclick="app.tagPatient('Green')">ç¶  Green</button>
                        <button class="btn-triage black" onclick="app.tagPatient('Black')">é»‘ Black</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const CASES = [
            { id: "MCI-01", type: "Black", title: "Cå€-è¢«æ°´æ³¥å£“ä½", findings: { head: {text:"é ­é¡±è®Šå½¢ï¼Œè…¦çµ„ç¹”å¤–æº¢ï¼Œç„¡å‘¼å¸", icon:"ğŸ’€"}, chest: {text:"ç„¡èµ·ä¼", icon:""}, abdomen: {text:"ç„¡æ³•è©•ä¼°", icon:""}, arm_l: {text:"ç„¡åæ‡‰", icon:""}, arm_r: {text:"ç„¡åæ‡‰", icon:""}, leg_l: {text:"è¢«å£“ä½", icon:""}, leg_r: {text:"è¢«å£“ä½", icon:""} }, is_x: false, feedback: "éŒ¯èª¤ã€‚å‚·æ‚£æœ‰æ˜é¡¯æ­»äº¡å¾µè±¡(è…¦çµ„ç¹”å¤–æº¢)ä¸”ç„¡å‘¼å¸ï¼Œæ‡‰ç‚ºé»‘ç‰Œã€‚" },
            { id: "MCI-02", type: "Red", title: "Bå€-å‘¼å¸æ€¥ä¿ƒæŠ“å–‰åš¨", findings: { head: {text:"çœ‰æ¯›ç‡’ç„¦ï¼Œå£ä¸­æœ‰ç¢³ç²’ï¼Œç™¼å‡ºå–˜é³´è²", icon:"ğŸ”¥"}, chest: {text:"å‘¼å¸32æ¬¡/åˆ†ï¼Œé ¸éœè„ˆæ€’å¼µ", icon:"âš ï¸"}, abdomen: {text:"ç„¡å¤–å‚·", icon:""}, arm_l: {text:"äºŒåº¦ç‡’å‚·", icon:""}, arm_r: {text:"äºŒåº¦ç‡’å‚·", icon:""}, leg_l: {text:"ç„¡å¤–å‚·", icon:""}, leg_r: {text:"ç„¡å¤–å‚·", icon:""} }, is_x: false, feedback: "éŒ¯èª¤ã€‚å‘¼å¸é€Ÿç‡ > 30 ä¸”æœ‰å‘¼å¸é“ç‡’ç¼å‚·ï¼Œå±¬å„ªå…ˆæ•‘æ²»çš„ç´…ç‰Œã€‚" },
            { id: "MCI-03", type: "Red", title: "Bå€-å°–å«å¤§å‡ºè¡€", findings: { head: {text:"æ„è­˜æ¸…æ¥šï¼Œå°–å«å‘¼æ•‘", icon:"ğŸ˜¨"}, chest: {text:"å‘¼å¸26æ¬¡/åˆ†ï¼Œè†šè‰²è’¼ç™½", icon:""}, abdomen: {text:"ç„¡å¤–å‚·", icon:""}, arm_l: {text:"ç„¡å¤–å‚·", icon:""}, arm_r: {text:"ç„¡å¤–å‚·", icon:""}, leg_l: {text:"ç„¡å¤–å‚·", icon:""}, leg_r: {text:"ğŸ©¸ å³å¤§è…¿æˆªè‚¢ï¼Œå™´å°„ç‹€å‡ºè¡€ï¼", icon:"ğŸ©¸", is_x: true} }, is_x: true, death_timer: 60, feedback: "éŒ¯èª¤ã€‚å‚·æ‚£æœ‰å±åŠç”Ÿå‘½çš„å¤§å‡ºè¡€(X)ï¼Œéœ€ç«‹å³è™•ç½®ä¸¦å„ªå…ˆå¾Œé€ï¼Œå±¬ç´…ç‰Œã€‚" },
            { id: "MCI-04", type: "Red", title: "Cå€-åŠæ©åŸ‹", findings: { head: {text:"æ„è­˜ä¸æ¸…(GCS 9)ï¼Œå‘¼å¸é“æœ‰åˆ†æ³Œç‰©", icon:"ğŸ¥´"}, chest: {text:"å‘¼å¸æ·ºå¿« 8æ¬¡/åˆ†", icon:""}, abdomen: {text:"å£“ç—›", icon:""}, arm_l: {text:"æ“¦å‚·", icon:""}, arm_r: {text:"æ“¦å‚·", icon:""}, leg_l: {text:"è¢«ç“¦ç¤«å£“ä½", icon:""}, leg_r: {text:"è¢«ç“¦ç¤«å£“ä½", icon:""} }, is_x: false, feedback: "éŒ¯èª¤ã€‚æ„è­˜ä¸æ¸… (GCS<10) ä¸”å‘¼å¸é€Ÿç‡ç•°å¸¸ (<10)ï¼Œå±¬ç´…ç‰Œã€‚" },
            { id: "MCI-05", type: "Yellow", title: "Aå€-åè‘—æŠ±æ‰‹è‡‚", findings: { head: {text:"æ„è­˜æ¸…æ¥šï¼Œä¸»è¨´æ‰‹ç—›", icon:"ğŸ™‚"}, chest: {text:"å‘¼å¸20æ¬¡/åˆ†", icon:""}, abdomen: {text:"è»Ÿ", icon:""}, arm_l: {text:"å·¦ä¸Šè‡‚è®Šå½¢ï¼Œç„¡å¤§å‡ºè¡€", icon:"ğŸ¦´"}, arm_r: {text:"ç„¡å¤–å‚·", icon:""}, leg_l: {text:"ç»ç’ƒå‰²å‚·", icon:""}, leg_r: {text:"ç„¡å¤–å‚·", icon:""} }, is_x: false, feedback: "éŒ¯èª¤ã€‚ç”Ÿå‘½å¾µè±¡ç©©å®šï¼Œç„¡æ³•è¡Œèµ°ä½†ç„¡ç«‹å³ç”Ÿå‘½å±éšªï¼Œå±¬é»ƒç‰Œã€‚" },
            { id: "MCI-06", type: "Yellow", title: "Aå€-èƒ¸ç—›", findings: { head: {text:"æ„è­˜æ¸…æ¥š", icon:""}, chest: {text:"å‰èƒ¸æŒ«å‚·ï¼Œå‘¼å¸22æ¬¡/åˆ†ï¼Œç—›", icon:"ğŸ©¹"}, abdomen: {text:"è»Ÿ", icon:""}, arm_l: {text:"ç„¡å¤–å‚·", icon:""}, arm_r: {text:"ç„¡å¤–å‚·", icon:""}, leg_l: {text:"ç„¡å¤–å‚·", icon:""}, leg_r: {text:"ç„¡å¤–å‚·", icon:""} }, is_x: false, feedback: "éŒ¯èª¤ã€‚ç”Ÿå‘½å¾µè±¡ç©©å®šï¼Œé›–æœ‰èƒ¸ç—›ä½†ç„¡æ°£èƒ¸å¾µè±¡ï¼Œå±¬é»ƒç‰Œã€‚" },
            { id: "MCI-07", type: "Yellow", title: "Bå€-è·Œåå–Šç—›", findings: { head: {text:"æ„è­˜æ¸…æ¥šï¼Œè¡¨æƒ…ç—›è‹¦", icon:""}, chest: {text:"å‘¼å¸20æ¬¡/åˆ†", icon:""}, abdomen: {text:"éª¨ç›†æ“ å£“ç—›ï¼Œç„¡æ³•ç«™ç«‹", icon:"âš¡"}, arm_l: {text:"ç„¡å¤–å‚·", icon:""}, arm_r: {text:"ç„¡å¤–å‚·", icon:""}, leg_l: {text:"ç„¡å¤–å‚·", icon:""}, leg_r: {text:"ç„¡å¤–å‚·", icon:""} }, is_x: false, feedback: "éŒ¯èª¤ã€‚éª¨ç›†éª¨æŠ˜ä½†ç„¡ä¼‘å…‹å¾µè±¡ï¼Œå±¬é»ƒç‰Œã€‚" },
            { id: "MCI-08", type: "Yellow", title: "Aå€-æ‘€è‚šå­", findings: { head: {text:"æ„è­˜æ¸…æ¥šï¼Œå†’å†·æ±—", icon:""}, chest: {text:"å‘¼å¸24æ¬¡/åˆ†", icon:""}, abdomen: {text:"è…¸é“å¤–éœ² (Evisceration)", icon:"ğŸŒ­"}, arm_l: {text:"ç„¡å¤–å‚·", icon:""}, arm_r: {text:"ç„¡å¤–å‚·", icon:""}, leg_l: {text:"ç„¡å¤–å‚·", icon:""}, leg_r: {text:"ç„¡å¤–å‚·", icon:""} }, is_x: false, feedback: "éŒ¯èª¤ã€‚è‡Ÿå™¨å¤–éœ²éœ€è™•ç½®ï¼Œä½†ç›®å‰å‘¼å¸å¾ªç’°å°šå¯ (å»¶å¾Œå¾Œé€)ã€‚" },
            { id: "MCI-09", type: "Red", title: "Bå€-å‘¼å¸å›°é›£", findings: { head: {text:"æ„è­˜æ¸…æ¥šä½†ç„¦èº", icon:"ğŸ˜°"}, chest: {text:"å³èƒ¸ç–¼ç—›ï¼Œå‘¼å¸36æ¬¡/åˆ† (æ°£èƒ¸æƒ¡åŒ–)", icon:"ğŸ“‰"}, abdomen: {text:"è»Ÿ", icon:""}, arm_l: {text:"ç„¡å¤–å‚·", icon:""}, arm_r: {text:"ç„¡å¤–å‚·", icon:""}, leg_l: {text:"ç„¡å¤–å‚·", icon:""}, leg_r: {text:"ç„¡å¤–å‚·", icon:""} }, is_x: false, crisis_mode: true, feedback: "éŒ¯èª¤ã€‚å‘¼å¸é€Ÿç‡ > 30 (å¼µåŠ›æ€§æ°£èƒ¸æƒ¡åŒ–)ï¼Œæ‡‰ç«‹å³å‡ç´šç‚ºç´…ç‰Œã€‚" },
            { id: "MCI-10", type: "Green", title: "Aå€-èµ°å‹•", findings: { head: {text:"æ„è­˜æ¸…æ¥š", icon:""}, chest: {text:"å‘¼å¸æ­£å¸¸", icon:""}, abdomen: {text:"è»Ÿ", icon:""}, arm_l: {text:"æ“¦å‚·", icon:""}, arm_r: {text:"ç„¡", icon:""}, leg_l: {text:"ç„¡", icon:""}, leg_r: {text:"ç„¡", icon:""} }, is_x: false, feedback: "éŒ¯èª¤ã€‚å¯è¡Œèµ°ä¸”ç„¡ä¸»è¨´åš´é‡ä¸é©ï¼Œå±¬ç¶ ç‰Œã€‚" },
            { id: "MCI-11", type: "Green", title: "Aå€-èµ°å‹•", findings: { head: {text:"æ„è­˜æ¸…æ¥š", icon:""}, chest: {text:"å‘¼å¸æ­£å¸¸", icon:""}, abdomen: {text:"è»Ÿ", icon:""}, arm_l: {text:"ç„¡", icon:""}, arm_r: {text:"æ‰­å‚·", icon:""}, leg_l: {text:"ç„¡", icon:""}, leg_r: {text:"ç„¡", icon:""} }, is_x: false, feedback: "éŒ¯èª¤ã€‚å¯è¡Œèµ°ï¼Œå±¬ç¶ ç‰Œã€‚" },
            { id: "MCI-12", type: "Green", title: "Aå€-é©šåš‡", findings: { head: {text:"é©šåš‡éåº¦ï¼Œä½†åœ¨å“­", icon:"ğŸ˜­"}, chest: {text:"å‘¼å¸å¿«ä½†æ­£å¸¸", icon:""}, abdomen: {text:"è»Ÿ", icon:""}, arm_l: {text:"ç„¡", icon:""}, arm_r: {text:"ç„¡", icon:""}, leg_l: {text:"ç„¡", icon:""}, leg_r: {text:"ç„¡", icon:""} }, is_x: false, feedback: "éŒ¯èª¤ã€‚å¿ƒç†é©šåš‡ä½†ç„¡å¤–å‚·ï¼Œå±¬ç¶ ç‰Œã€‚" },
            { id: "MCI-13", type: "Green", title: "Aå€-èµ°å‹•", findings: { head: {text:"æ„è­˜æ¸…æ¥š", icon:""}, chest: {text:"å‘¼å¸æ­£å¸¸", icon:""}, abdomen: {text:"è»Ÿ", icon:""}, arm_l: {text:"ç„¡", icon:""}, arm_r: {text:"ç„¡", icon:""}, leg_l: {text:"æ“¦å‚·", icon:""}, leg_r: {text:"ç„¡", icon:""} }, is_x: false, feedback: "éŒ¯èª¤ã€‚è¼•å¾®æ“¦å‚·å¯è¡Œèµ°ï¼Œå±¬ç¶ ç‰Œã€‚" },
            { id: "MCI-14", type: "Green", title: "Aå€-å€’åœ°æŠ½æ", findings: { head: {text:"E1V1M1 (æŠ½æä¸­)", icon:"âš¡"}, chest: {text:"å‘¼å¸æ·ºå¿«", icon:""}, abdomen: {text:"è»Ÿ", icon:""}, arm_l: {text:"æŠ½æ", icon:""}, arm_r: {text:"æŠ½æ", icon:""}, leg_l: {text:"æŠ½æ", icon:""}, leg_r: {text:"æŠ½æ", icon:""} }, is_x: false, crisis_mode: true, feedback: "éŒ¯èª¤ã€‚ç™²ç™‡ç™¼ä½œæ„è­˜å–ªå¤±ï¼Œç„¡æ³•è¡Œèµ°ï¼Œæ‡‰å‡ç´šç‚ºç´…ç‰Œã€‚" },
            { id: "MCI-15", type: "Green", title: "Aå€-èµ°å‹•", findings: { head: {text:"æ„è­˜æ¸…æ¥š", icon:""}, chest: {text:"å‘¼å¸æ­£å¸¸", icon:""}, abdomen: {text:"è»Ÿ", icon:""}, arm_l: {text:"ç„¡", icon:""}, arm_r: {text:"ç„¡", icon:""}, leg_l: {text:"ç„¡", icon:""}, leg_r: {text:"æ‰­å‚·", icon:""} }, is_x: false, feedback: "éŒ¯èª¤ã€‚å¯è¡Œèµ°ï¼Œå±¬ç¶ ç‰Œã€‚" }
        ];

        const app = {
            state: {
                currentCase: null,
                assessedParts: [],
                log: [],
                x_treated: false,
                inCrisis: false,
                completedIds: [],
                userDecisions: {}, // Store user choice here { id: 'Red' }
                greenBroadcasted: false,
                timerId: null,
                deathCountdown: 0,
                isDead: false,
                triageCounts: { Red: 0, Yellow: 0, Green: 0, Black: 0 },
                missionTime: 600, // 10 minutes
                missionTimerId: null
            },

            startMission: function() {
                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block'; // Show dashboard ONLY after start
                this.initDraggable();
                this.renderSceneMap();
                audioSys.init();
                this.startMissionTimer();
            },

            startMissionTimer: function() {
                this.state.missionTimerId = setInterval(() => {
                    this.state.missionTime--;
                    const m = Math.floor(this.state.missionTime / 60);
                    const s = this.state.missionTime % 60;
                    const display = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                    const el = document.getElementById('mission-timer');
                    if(el) el.innerText = display;
                    
                    if(this.state.missionTime <= 60 && el) el.classList.add('urgent');
                    if(this.state.missionTime <= 0) {
                        clearInterval(this.state.missionTimerId);
                        alert("ä»»å‹™æ™‚é–“çµæŸï¼å¼·åˆ¶é€²å…¥å›å ±éšæ®µã€‚");
                        this.showFinalReport();
                    }
                }, 1000);
            },

            toggleDash: function() {
                const el = document.getElementById('dash-content');
                if (el.classList.contains('collapsed')) {
                    el.classList.remove('collapsed');
                } else {
                    el.classList.add('collapsed');
                }
            },

            initDraggable: function() {
                const dash = document.getElementById('dashboard');
                const header = document.getElementById('dash-header');
                let isDragging = false, startX, startY, initialLeft, initialTop;

                const startDrag = (clientX, clientY) => {
                    isDragging = true;
                    startX = clientX;
                    startY = clientY;
                    initialLeft = dash.offsetLeft;
                    initialTop = dash.offsetTop;
                };

                const doDrag = (clientX, clientY) => {
                    if (!isDragging) return;
                    dash.style.left = (initialLeft + clientX - startX) + 'px';
                    dash.style.top = (initialTop + clientY - startY) + 'px';
                };

                const endDrag = () => { isDragging = false; };

                // Mouse events
                header.onmousedown = (e) => { startDrag(e.clientX, e.clientY); };
                document.onmouseup = endDrag;
                document.onmousemove = (e) => { doDrag(e.clientX, e.clientY); };

                // Touch events
                header.ontouchstart = (e) => { 
                    const touch = e.touches[0];
                    startDrag(touch.clientX, touch.clientY); 
                    // Don't prevent default too aggressively or clicks might fail, but for header drag it's usually safe
                };
                document.ontouchend = endDrag;
                document.ontouchmove = (e) => { 
                    if(isDragging) e.preventDefault(); // Prevent scroll when dragging
                    const touch = e.touches[0];
                    doDrag(touch.clientX, touch.clientY); 
                };
            },

            renderSceneMap: function() {
                document.getElementById('scene-view').style.display = 'block';
                document.getElementById('patient-view').style.display = 'none';
                
                const total = CASES.length;
                const done = this.state.completedIds.length;
                document.getElementById('pending-count').innerText = total - done;

                if (done === total) {
                    this.showFinalReport();
                    return;
                }

                const map = document.getElementById('map-container');
                map.querySelectorAll('.patient-dot').forEach(e => e.remove());
                
                CASES.forEach((c, idx) => {
                    if (this.state.completedIds.includes(c.id)) return;

                    const dot = document.createElement('div');
                    dot.className = 'patient-dot';
                    dot.innerText = `P${idx+1}`;
                    
                    let top, left;
                    if(c.title.includes("Aå€")) { top=10+Math.random()*20; left=10+Math.random()*20; }
                    else if(c.title.includes("Bå€")) { top=40+Math.random()*20; left=40+Math.random()*20; }
                    else if(c.title.includes("Cå€")) { top=70+Math.random()*20; left=10+Math.random()*20; }
                    else { top=Math.random()*80+10; left=Math.random()*80+10; } 

                    dot.style.top = top + '%';
                    dot.style.left = left + '%';
                    
                    if (this.state.greenBroadcasted && c.type === 'Green' && c.id !== 'MCI-14') {
                        dot.classList.add('green-walk');
                        setTimeout(() => {
                            if(!this.state.completedIds.includes(c.id)) {
                                this.updateTriageCount('Green');
                                this.state.completedIds.push(c.id);
                                this.state.userDecisions[c.id] = 'Green'; // Auto tag
                                dot.remove(); 
                                this.renderSceneMap(); 
                            }
                        }, 1000);
                    } else {
                        dot.onclick = () => this.enterCase(c);
                    }
                    map.appendChild(dot);
                });
            },

            broadcastGreen: function() {
                if(this.state.greenBroadcasted) return;
                this.state.greenBroadcasted = true;
                document.getElementById('btn-broadcast').disabled = true;
                document.getElementById('btn-broadcast').innerText = "âœ… ç¶ ç‰Œå‚·æ‚£å·²é›†çµ";
                audioSys.playTone('correct');
                this.renderSceneMap();
            },

            enterCase: function(c) {
                if (!c) return;
                this.state.currentCase = c;
                this.state.assessedParts = [];
                this.state.log = [`>> æ¥è§¸å‚·æ‚£: ${c.title}`, `>> è¦–è¨ºï¼šè«‹é»æ“Šèº«é«”éƒ¨ä½é€²è¡Œè©•ä¼°ã€‚`];
                this.state.x_treated = false;
                this.state.inCrisis = false;
                this.state.isDead = false;
                
                document.getElementById('scene-view').style.display = 'none';
                document.getElementById('patient-view').style.display = 'flex';
                document.getElementById('case-title').innerText = `CASE: ${c.id}`;
                
                document.querySelectorAll('.body-part').forEach(el => {
                    if (el) el.classList.remove('assessed', 'injured', 'critical-x');
                });
                document.getElementById('body-overlays').innerHTML = '';

                if (c.death_timer) {
                    this.state.deathCountdown = c.death_timer;
                    const timerEl = document.getElementById('bleed-timer');
                    timerEl.style.display = 'block';
                    timerEl.innerText = `${this.state.deathCountdown}s`;
                    
                    if (this.state.timerId) clearInterval(this.state.timerId);
                    this.state.timerId = setInterval(() => {
                        if (this.state.x_treated || this.state.isDead) {
                            clearInterval(this.state.timerId);
                            timerEl.style.display = 'none';
                            return;
                        }
                        this.state.deathCountdown--;
                        timerEl.innerText = `${this.state.deathCountdown}s`;
                        if (this.state.deathCountdown <= 0) {
                            this.triggerDeath("å¤±è¡€éå¤š");
                        }
                    }, 1000);
                } else {
                    document.getElementById('bleed-timer').style.display = 'none';
                }

                if (c.is_x) {
                    const xKey = Object.keys(c.findings).find(k => c.findings[k].is_x);
                    if(xKey) {
                        const el = document.getElementById(`part-${xKey}`);
                        if (el) el.classList.add('critical-x');
                        this.log(`âš ï¸ å¤–è§€ç™¼ç¾ï¼šå¤§é‡å™´å°„ç‹€å‡ºè¡€ï¼`, 'warn');
                    }
                }

                this.updateLog();
                this.renderActions();
            },

            triggerDeath: function(reason) {
                if (this.state.timerId) clearInterval(this.state.timerId);
                this.state.isDead = true;
                this.state.currentCase.type = 'Black'; 
                this.state.currentCase.feedback = "æ­£ç¢ºã€‚å‚·æ‚£å·²ç„¡ç”Ÿå‘½å¾µè±¡ï¼ŒMCI åˆ¤å®šç‚ºé»‘ç‰Œã€‚";
                this.log(`ğŸ’€ å‚·æ‚£å› ${reason}ï¼Œå¿ƒè·³åœæ­¢ (OHCA)ã€‚`, 'death');
                this.log(`âš ï¸ é€²å…¥ OHCA æµç¨‹ï¼šMCI è³‡æºæœ‰é™ï¼Œæ‡‰åˆ¤å®šç‚ºé»‘ç‰Œã€‚`, 'sys');
                audioSys.playTone('wrong');
                this.renderActions();
            },

            assessPart: function(partId) {
                if (this.state.inCrisis) return;
                if (this.state.isDead) return;

                const c = this.state.currentCase;
                const data = c.findings[partId];
                
                // XABCDE Rule check (Simplified)
                const hasX = Object.values(c.findings).some(f => f.is_x);
                if (hasX && !this.state.x_treated && !data.is_x) {
                    this.log(`âŒ é•å XABCDEï¼ç™¼ç¾å¤§å‡ºè¡€ï¼Œæ‡‰å„ªå…ˆæ­¢è¡€ï¼`, 'warn');
                    audioSys.playTone('wrong');
                    return;
                }

                if (!this.state.assessedParts.includes(partId)) {
                    this.state.assessedParts.push(partId);
                    const el = document.getElementById(`part-${partId}`);
                    if(el) { 
                        el.classList.add('assessed');
                        if (data.text.includes('å‚·') || data.text.includes('è¡€') || data.text.includes('ç—›') || data.is_x || data.text.includes('è®Šå½¢') || data.text.includes('ç‡’å‚·') || data.text.includes('ç„¡åæ‡‰')) {
                            el.classList.add('injured');
                        }
                        this.showFloatingLabel(el, data.text);
                    }
                    this.log(`ğŸ” è©•ä¼° ${partId}: ${data.text}`);
                }

                this.renderActions(); 
                this.triggerRandomCrisis();
            },

            showFloatingLabel: function(el, text) {
                if (!el) return;
                const container = document.getElementById('body-overlays');
                const label = document.createElement('div');
                label.className = 'finding-label';
                label.innerText = text.length > 12 ? text.substring(0,12)+"..." : text;
                const id = el.id;
                // Rough positioning logic
                if(id.includes('head')) { label.style.top = '10%'; label.style.left = '50%'; }
                else if(id.includes('chest')) { label.style.top = '25%'; label.style.left = '50%'; }
                else if(id.includes('abdomen')) { label.style.top = '40%'; label.style.left = '50%'; }
                else if(id.includes('leg')) { label.style.top = '70%'; label.style.left = '50%'; }
                else { label.style.top = '50%'; label.style.left = '50%'; }
                label.style.transform = 'translateX(-50%)';
                container.appendChild(label);
                setTimeout(() => label.remove(), 3000);
            },

            renderActions: function() {
                const panel = document.getElementById('action-panel');
                panel.innerHTML = '';
                const c = this.state.currentCase;

                if (this.state.isDead) {
                    panel.innerHTML = `<div class="log-entry death">å‚·æ‚£å·²æ­»äº¡ã€‚è«‹æ¨™è¨˜é»‘ç‰Œã€‚</div>`;
                    return;
                }

                if (c.is_x && !this.state.x_treated) {
                    const xPart = Object.keys(c.findings).find(k => c.findings[k].is_x);
                    if (this.state.assessedParts.includes(xPart)) {
                        panel.innerHTML += `<button class="btn-action priority" onclick="app.performAction('tq')"><span>ğŸ©¸ ä½¿ç”¨æ­¢è¡€å¸¶ (Tourniquet)</span></button>`;
                    }
                    return; 
                }

                if (this.state.assessedParts.includes('head')) {
                    panel.innerHTML += `
                    <div style="display:flex; gap:5px;">
                        <button class="btn-action" style="flex:1" onclick="app.performAction('opa')">ğŸ« å£å’½ (OPA)</button>
                        <button class="btn-action" style="flex:1" onclick="app.performAction('npa')">ğŸ‘ƒ é¼»å’½ (NPA)</button>
                    </div>
                    <button class="btn-action" onclick="app.performAction('pain')">âš¡ åˆºæ¿€æ–œæ–¹è‚Œ (Pain)</button>
                    `;
                }

                if (c.findings.abdomen.text.includes('è…¸')) {
                     panel.innerHTML += `<button class="btn-action" onclick="app.performAction('gut')">ğŸ©¹ æ¿•æ½¤æ•·æ–™è¦†è“‹</button>`;
                }
            },

            performAction: function(act) {
                const c = this.state.currentCase;
                
                if (act === 'tq') {
                    this.state.x_treated = true;
                    if(this.state.timerId) clearInterval(this.state.timerId); 
                    document.getElementById('bleed-timer').style.display = 'none';
                    this.log(`âœ… æ­¢è¡€å¸¶ (CAT) å·²ä½¿ç”¨ã€‚å‡ºè¡€åœæ­¢ã€‚`, 'action');
                    document.querySelectorAll('.critical-x').forEach(el => el.classList.remove('critical-x'));
                    this.renderActions();
                } else if (act === 'opa') {
                    if (c.findings.head.text.includes('æ¸…æ¥š') || c.findings.head.text.includes('å¼µå¤§çœ¼')) {
                        this.log(`âŒ å‚·æ‚£æ’æ–¥ OPAï¼(æœ‰å˜”ååå°„)`, 'warn');
                        audioSys.playTone('wrong');
                    } else {
                        this.log(`âœ… OPA ç½®å…¥æˆåŠŸã€‚`, 'action');
                    }
                } else if (act === 'npa') {
                    this.log(`âœ… NPA ç½®å…¥æˆåŠŸã€‚`, 'action');
                } else if (act === 'pain') {
                    if (c.findings.head.text.includes('ç„¡åæ‡‰')) {
                        this.log(`âš¡ åˆºæ¿€æ–œæ–¹è‚Œ... ä»ç„¡åæ‡‰ã€‚`, 'action');
                    } else if (c.findings.head.text.includes('æ¸…æ¥š')) {
                        this.log(`âš¡ å‚·æ‚£æ’¥é–‹ä½ çš„æ‰‹ï¼`, 'warn');
                    } else {
                        this.log(`âš¡ åˆºæ¿€æ–œæ–¹è‚Œ... å‚·æ‚£è‚¢é«”å±ˆæ›²/ä¼¸å¼µã€‚`, 'action');
                    }
                } else if (act === 'gut') {
                    this.log(`âœ… å·²ä½¿ç”¨ç„¡èŒæ¿•æ•·æ–™è¦†è“‹ã€‚`, 'action');
                }
            },

            tagPatient: function(color) {
                if (this.state.inCrisis) return;
                const c = this.state.currentCase;
                
                // NO FEEDBACK during tagging.
                this.state.completedIds.push(c.id);
                this.state.userDecisions[c.id] = color;
                
                this.updateTriageCount(color);
                
                if(this.state.timerId) clearInterval(this.state.timerId);
                this.returnToScene();
            },

            updateTriageCount: function(color) {
                this.state.triageCounts[color]++;
                document.getElementById(`count-${color.charAt(0).toLowerCase()}`).innerText = this.state.triageCounts[color];
            },

            triggerRandomCrisis: function() {
                if (this.state.inCrisis || this.state.currentCase.type === 'Black' || this.state.isDead) return;
                
                if (Math.random() < 0.1) {
                    if (Math.random() > 0.5) {
                        // Air Raid
                        this.state.inCrisis = true;
                        document.getElementById('crisis-overlay').style.display = 'flex';
                        audioSys.playTone('alarm');
                        
                        // Post-Raid Consequence
                        if (this.state.currentCase.is_x && !this.state.x_treated) {
                            setTimeout(() => {
                                if (this.state.inCrisis) return; 
                                this.log(`âš ï¸ ç©ºè¥²å»¶èª¤è™•ç½®ï¼Œå‚·æ‚£å› å¤§å‡ºè¡€ä¼‘å…‹æ­»äº¡ï¼`, 'death');
                                this.triggerDeath("ç©ºè¥²å»¶èª¤æ­¢è¡€");
                            }, 5000); 
                        }

                    } else if (this.state.currentCase.crisis_mode) {
                        // Deterioration
                        if (this.state.currentCase.id === 'MCI-14') {
                            this.log(`ğŸš¨ å‚·æ‚£çªç„¶å€’åœ°æŠ½æï¼(ç™²ç™‡ç™¼ä½œ)`, 'warn');
                            this.state.currentCase.type = 'Red';
                            this.state.currentCase.feedback = "æ­£ç¢ºã€‚ç™²ç™‡ç™¼ä½œæ„è­˜ä¸æ¸…ï¼Œå±¬ç´…ç‰Œã€‚";
                        } else {
                            this.log(`ğŸš¨ å‚·æ‚£çªç„¶å‘¼å¸æ€¥ä¿ƒï¼Œè¡€æ°§ä¸‹é™ï¼(æ°£èƒ¸æƒ¡åŒ–)`, 'warn');
                            this.state.currentCase.type = 'Red';
                        }
                        audioSys.playTone('wrong');
                    }
                }
            },

            resolveCrisis: function() {
                document.getElementById('crisis-overlay').style.display = 'none';
                this.state.inCrisis = false;
                this.log(`âœ… å±æ©Ÿè§£é™¤ã€‚`, 'sys');
                
                if (this.state.currentCase.is_x && !this.state.x_treated) {
                    this.triggerDeath("ç©ºè¥²æœŸé–“å¤±è¡€éå¤š");
                }
            },

            log: function(msg, type='') {
                this.state.log.push(msg);
                this.updateLog();
            },
            
            updateLog: function() {
                const el = document.getElementById('log-display');
                el.innerHTML = '';
                this.state.log.forEach(txt => {
                    const div = document.createElement('div');
                    div.className = 'log-entry';
                    if(txt.includes('âŒ') || txt.includes('âš ï¸') || txt.includes('ğŸ’€')) div.classList.add('warn');
                    if(txt.includes('âœ…') || txt.includes('ğŸš‘')) div.classList.add('action');
                    if(txt.includes('>>')) div.classList.add('sys');
                    div.innerText = txt;
                    el.appendChild(div);
                });
                el.scrollTop = el.scrollHeight;
            },

            returnToScene: function() {
                this.renderSceneMap();
            },

            showFinalReport: function() {
                document.getElementById('scene-view').style.display = 'none';
                document.getElementById('patient-view').style.display = 'none';
                document.getElementById('report-modal').style.display = 'flex';
            },

            submitReport: function() {
                const r = parseInt(document.getElementById('rep-r').value) || 0;
                const y = parseInt(document.getElementById('rep-y').value) || 0;
                const g = parseInt(document.getElementById('rep-g').value) || 0;
                const b = parseInt(document.getElementById('rep-b').value) || 0;
                
                const totalInput = r + y + g + b;

                if (totalInput !== 15) {
                    alert(`ç›®å‰ç¸½äººæ•¸ç‚º ${totalInput} äººï¼Œæ‡‰ç‚º 15 äººã€‚è«‹é‡æ–°ç¢ºèªã€‚`);
                    return;
                }

                this.generateEnding();
            },

            generateEnding: function() {
                document.getElementById('report-modal').style.display = 'none';
                document.getElementById('dashboard').style.display = 'none'; // Hide floating dash in ending
                
                const modal = document.getElementById('ending-modal');
                const title = document.getElementById('ending-title');
                const body = document.getElementById('ending-body');
                const review = document.getElementById('ending-review');
                
                let correctCount = 0;
                let criticalFail = false;
                let reviewHtml = "";

                CASES.forEach(c => {
                    const userChoice = this.state.userDecisions[c.id] || "Unknown";
                    const actualType = c.type;
                    
                    let statusClass = "error";
                    let consequence = "";

                    if (userChoice === actualType) {
                        correctCount++;
                        statusClass = "ok";
                        reviewHtml += `<div class="case-item ok">âœ… ${c.id}: åˆ¤æ–·æ­£ç¢º (${actualType})</div>`;
                    } else {
                        if (actualType === 'Red' && userChoice === 'Green') {
                            consequence = "åš´é‡èª¤åˆ¤ï¼ç´…ç‰Œå‚·æ‚£è¢«æ»¯ç•™ç¶ å€ï¼Œå› å»¶èª¤å¾Œé€è€Œæ­»äº¡ã€‚";
                            criticalFail = true;
                        } else if (actualType === 'Red' && userChoice === 'Yellow') {
                            consequence = "èª¤åˆ¤ç‚ºé»ƒç‰Œï¼Œå‚·æ‚£åœ¨ç­‰å¾…å€ç—…æƒ…æƒ¡åŒ–ã€‚";
                        } else if (actualType === 'Black' && userChoice === 'Red') {
                            consequence = "å°æ˜é¡¯æ­»äº¡è€…é€²è¡Œç„¡æ•ˆæ€¥æ•‘ï¼Œæµªè²»å¯¶è²´è³‡æºã€‚";
                        } else if (actualType === 'Green' && userChoice === 'Red') {
                            consequence = "è¼•å‚·ä½”ç”¨æ•‘è­·è»Šï¼Œå°è‡´é‡ç—‡å‚·æ‚£ç„¡è»Šå¯é€ã€‚";
                        } else {
                            consequence = `åˆ†é¡éŒ¯èª¤ (æ‡‰ç‚º ${actualType})ï¼Œå½±éŸ¿æª¢å‚·æº–ç¢ºåº¦ã€‚`;
                        }
                        
                        reviewHtml += `
                        <div class="case-item error">
                            âŒ ${c.id}: æ‚¨æ¨™è¨˜ <span style="font-weight:bold">${userChoice}</span> (æ‡‰ç‚º ${actualType})<br>
                            <span style="font-size:0.85rem; color:#C0392B;">â¤ å¾Œæœï¼š${consequence}</span><br>
                            <span style="font-size:0.85rem; color:#555;">â¤ è§£æï¼š${c.feedback}</span>
                        </div>`;
                    }
                });

                review.innerHTML = reviewHtml;
                modal.style.display = 'flex';

                if (correctCount === 15) {
                    title.innerHTML = "ğŸ† å®Œç¾çµå±€ï¼šå‚³å¥‡æŒ‡æ®å®˜";
                    title.style.color = "#27AE60";
                    body.innerHTML = `
                    <p>æŒ‡æ®ä¸­å¿ƒï¼šã€Œæ”¶åˆ°æ•¸æ“šã€‚æ‰€æœ‰å‚·æ‚£åˆ†é¡ç²¾ç¢ºç„¡èª¤ï¼Œå¾Œé€æ•ˆç‡æ¥µé«˜ã€‚ã€</p>
                    <p>åœ¨æ‚¨çš„å†·éœæŒ‡æ®ä¸‹ï¼Œæ‰€æœ‰é‡ç—‡å‚·æ‚£éƒ½åœ¨é»ƒé‡‘æ™‚é–“å…§ç²æ•‘ã€‚æ‚¨æˆåŠŸé åˆ¤äº†ç—…æƒ…æƒ¡åŒ–ï¼Œä¸¦åœ¨ç©ºè¥²ä¸­ä¿è­·äº†å‚·æ‚£ã€‚</p>
                    <p>é€™æ˜¯ä¸€æ¬¡ç„¡æ‡ˆå¯æ“Šçš„å¤§é‡å‚·ç—…æ‚£æ¼”ç·´ã€‚</p>`;
                } else if (criticalFail) {
                    title.innerHTML = "ğŸ’€ æ…˜çƒˆçµå±€ï¼šé˜²ç·šå´©æ½°";
                    title.style.color = "#C0392B";
                    body.innerHTML = `
                    <p>æŒ‡æ®ä¸­å¿ƒï¼šã€Œç¾å ´å›å ±æ··äº‚ï¼å¤šåé‡ç—‡å‚·æ‚£æœªè¢«åŠæ™‚ç™¼ç¾...ã€</p>
                    <p>ç”±æ–¼é—œéµçš„æª¢å‚·éŒ¯èª¤ï¼ˆå°‡ç´…ç‰Œèª¤åˆ¤ç‚ºç¶ ç‰Œï¼‰ï¼Œå°è‡´å‚·æ‚£åœ¨ç­‰å¾…å€æ­»äº¡ã€‚é†«ç™‚è³‡æºè¢«è¼•å‚·è€…ä½”ç”¨ï¼Œç¾å ´é™·å…¥å¤±æ§ã€‚</p>
                    <p>è«‹å‹™å¿…è©³é–±ä¸‹æ–¹æª¢è¨å ±å‘Šï¼Œé‡æ–°è¤‡ç¿’ START æª¢å‚·æµç¨‹ã€‚</p>`;
                } else {
                    title.innerHTML = "âš ï¸ æ™®é€šçµå±€ï¼šå°šæœ‰æ”¹é€²ç©ºé–“";
                    title.style.color = "#E67E22";
                    body.innerHTML = `
                    <p>æŒ‡æ®ä¸­å¿ƒï¼šã€Œæ”¶åˆ°æ•¸æ“šã€‚é›–ç„¶å¤§éƒ¨ä»½å‚·æ‚£å·²è™•ç†ï¼Œä½†ç¾å ´ä»æœ‰éƒ¨åˆ†èª¤åˆ¤æƒ…å½¢ã€‚ã€</p>
                    <p>æ‚¨å®Œæˆäº†åŸºæœ¬ä»»å‹™ï¼Œä½†åœ¨é¢å°å‹•æ…‹ç—…æƒ…è®ŠåŒ–æˆ–é‚Šç·£å€‹æ¡ˆæ™‚åˆ¤æ–·ä¸å¤ ç²¾æº–ã€‚è«‹æª¢è¨éŒ¯èª¤æ¡ˆä¾‹ï¼Œæå‡æª¢å‚·æº–ç¢ºåº¦ã€‚</p>`;
                }
            }
        };

        const audioSys = {
            ctx: null,
            init: function() {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if(AudioContext) this.ctx = new AudioContext();
            },
            toggleMute: function() {
                if(this.ctx && this.ctx.state === 'suspended') this.ctx.resume();
            },
            playTone: function(type) {
                if (!this.ctx) return;
                const o = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                o.connect(g); g.connect(this.ctx.destination);
                const t = this.ctx.currentTime;
                if (type === 'alarm') {
                    o.type = 'square'; o.frequency.setValueAtTime(440, t); o.frequency.linearRampToValueAtTime(880, t+0.5); g.gain.setValueAtTime(0.2, t); g.gain.linearRampToValueAtTime(0, t+1.0); o.start(t); o.stop(t+1.0);
                } else if (type === 'correct') {
                    o.frequency.value = 600; g.gain.value = 0.1; o.start(); o.stop(t+0.1);
                } else {
                    o.type = 'sawtooth'; o.frequency.value = 150; g.gain.value = 0.1; o.start(); o.stop(t+0.3);
                }
            }
        };
    </script>
</body>
</html>