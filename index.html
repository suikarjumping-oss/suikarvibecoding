<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>EMT-1 æˆ°è¡“å…µæ¨ V43 | çµ‚æ¥µç©©å®šç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* --- 1. Design System --- */
        :root {
            --bg-color: #E6E2D8; 
            --paper-color: #FDFBF7;
            --text-main: #2F2F2F; 
            --primary: #2C3E50;
            --accent: #C0392B;    
            --header-height: 50px;
            --nav-height: 60px;
            --triage-height: 80px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; -webkit-user-select: none; }
        
        body {
            margin: 0; padding: 0;
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100dvh; width: 100vw;
            display: flex; flex-direction: column;
            overflow: hidden; position: fixed;
        }

        /* --- FX: High Stress --- */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .screen-shake { animation: shake 0.5s; animation-iteration-count: infinite; }

        .red-strobe {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(192, 57, 43, 0.3);
            pointer-events: none; /* é‡è¦ï¼šè®“é»æ“Šç©¿é€ */
            z-index: 4500; 
            display: none;
            animation: strobe 0.2s infinite alternate;
        }
        @keyframes strobe { from { opacity: 0.1; background:rgba(255,0,0,0.1); } to { opacity: 0.6; background:rgba(255,0,0,0.5); } }

        /* --- Header --- */
        header {
            height: var(--header-height);
            padding: 0 16px; background: #F4F3EF; border-bottom: 1px solid #aaa;
            display: flex; justify-content: center; align-items: center; z-index: 20;
            padding-top: env(safe-area-inset-top);
        }
        h1 { font-size: 1rem; font-weight: 700; color: var(--primary); letter-spacing: 1px; }
        .top-right-controls { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); padding-top: env(safe-area-inset-top); }
        .mute-btn { border: 1px solid #999; color: #555; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; background:none; cursor: pointer; }

        /* --- Main & View Containers --- */
        main { flex: 1; overflow: hidden; position: relative; display: flex; flex-direction: column; padding-bottom: calc(var(--nav-height) + env(safe-area-inset-bottom)); }

        #scene-view, #patient-view { width: 100%; height: 100%; position: relative; display: none; }
        #patient-view { background: var(--paper-color); flex-direction: column; }

        /* --- Triage Bar --- */
        #triage-bar {
            position: fixed; bottom: calc(var(--nav-height) + env(safe-area-inset-bottom)); 
            left: 0; width: 100%; height: var(--triage-height);
            background: #fff; border-top: 1px solid #ccc;
            padding: 10px; z-index: 2000; 
            display: none; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px;
        }
        .btn-triage { padding: 0; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 0.9rem; }
        .btn-triage.red { background: #C0392B; }
        .btn-triage.yellow { background: #F1C40F; color: #333; }
        .btn-triage.green { background: #27AE60; }
        .btn-triage.black { background: #2C3E50; }

        /* --- Dashboard (Highest Priority) --- */
        #dashboard {
            position: fixed; top: 80px; left: 20px; width: 44px; height: 44px;
            background: rgba(255,255,255,0.98); border: 1px solid #777;
            border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.5); 
            z-index: 6000; /* é«˜æ–¼ Modal */
            overflow: hidden; touch-action: none; 
            transition: width 0.2s, height 0.2s, border-radius 0.2s;
        }
        #dashboard.expanded { width: 170px; height: auto; border-radius: 8px; }
        .dash-icon { width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; color: var(--primary); }
        .dash-content { padding: 10px; display: none; }
        #dashboard.expanded .dash-icon { display: none; }
        #dashboard.expanded .dash-content { display: block; }
        .dash-header { background: var(--primary); color: white; padding: 8px; font-size: 0.85rem; font-weight: bold; display: flex; justify-content: space-between; align-items: center; margin: -10px -10px 10px -10px; cursor: move; }
        .dash-row { display: flex; justify-content: space-between; margin-bottom: 6px; border-bottom: 1px dotted #ccc; padding-bottom: 2px; font-size: 0.9rem;}

        /* --- Start Screen --- */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #E6E2D8; z-index: 4000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 20px;
        }
        .mission-card { background: #fff; border: 1px solid #999; padding: 25px; max-width: 400px; width: 100%; box-shadow: 0 10px 20px rgba(0,0,0,0.1); border-radius: 8px; }
        .btn-start { margin-top: 20px; padding: 15px 40px; background: var(--primary); color: #fff; border: none; font-size: 1.2rem; cursor: pointer; border-radius: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); font-weight: bold; width: 100%; }

        /* --- Map View --- */
        #scene-view { background: #EAECEE; }
        .map-grid {
            width: 100%; height: 100%; position: relative;
            background-image: linear-gradient(rgba(255,255,255,0.3) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.3) 1px, transparent 1px);
            background-size: 40px 40px;
        }
        .map-obj { position: absolute; font-size: 0.9rem; color: #555; pointer-events: none; text-align: center; font-weight: bold; border: 2px dashed #999; display:flex; align-items:center; justify-content:center; opacity:0.6; background: rgba(255,255,255,0.3); }
        .map-obj.zone-a { top: 5%; left: 5%; width: 40%; height: 40%; }
        .map-obj.zone-b { top: 5%; left: 50%; width: 45%; height: 40%; }
        .map-obj.zone-c { top: 50%; left: 5%; width: 90%; height: 35%; }
        
        .patient-dot {
            width: 48px; height: 48px; background: #7F8C8D; border: 3px solid #fff;
            border-radius: 50%; position: absolute; cursor: pointer;
            box-shadow: 0 3px 8px rgba(0,0,0,0.4);
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: #fff; font-size: 0.85rem; z-index: 10;
        }
        .patient-dot.done-Red { background: #C0392B; }
        .patient-dot.done-Yellow { background: #F1C40F; color: #333; }
        .patient-dot.done-Green { background: #27AE60; }
        .patient-dot.done-Black { background: #2C3E50; }
        .patient-dot.green-walk { animation: walkAway 1s forwards; }
        @keyframes walkAway { to { opacity: 0; transform: translate(100px, -100px); } }

        .broadcast-fab {
            position: absolute; bottom: 30px; right: 20px; 
            background: var(--accent); color: white; border: none; 
            width: 64px; height: 64px; border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-size: 1.8rem;
            display: flex; align-items: center; justify-content: center; z-index: 30; cursor: pointer;
        }
        #mission-timer {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: #0f0; font-family: 'Roboto Mono', monospace;
            font-size: 1.2rem; padding: 4px 12px; border-radius: 15px; z-index: 40; pointer-events: none; border: 1px solid #555;
        }
        #mission-timer.urgent { color: #e74c3c; animation: pulse-red 0.5s infinite; border-color: #e74c3c; font-weight:bold; font-size:1.4rem; }

        /* --- Patient View Elements --- */
        .pv-header { padding: 8px 12px; background: #fff; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .pv-content-scroll { flex: 1; overflow-y: auto; display: flex; flex-direction: column; padding-bottom: 150px; }
        .body-container { height: 380px; position: relative; background: #FDFBF7; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #ddd; }
        .body-part { fill: #E0E0E0; stroke: #999; stroke-width: 1.5; cursor: pointer; }
        .body-part.assessed { fill: #A9DFBF; stroke: #196F3D; }
        .body-part.injured { fill: #F5B7B1; stroke: #C0392B; }
        .body-part.critical-x { animation: pulse-red 0.5s infinite; fill: #E74C3C; }
        
        .finding-label {
            position: absolute; background: rgba(255,255,255,0.95); border: 2px solid #C0392B;
            padding: 8px; border-radius: 4px; font-size: 0.9rem; pointer-events: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); font-weight: bold; z-index: 20; color: #000;
        }
        .info-panel { padding: 15px; background: #fff; flex: 1; }
        .assessment-log { border: 1px solid #ccc; background: #FAFAFA; padding: 10px; margin-bottom: 15px; font-family: 'Courier New', monospace; font-size: 0.95rem; line-height: 1.5; height: 150px; overflow-y: auto; }
        .log-entry.warn { color: #922B21; background: #FDEDEC; border-left: 3px solid #C0392B; padding-left:5px; }
        .btn-action { padding: 15px; background: #fff; border: 1px solid #999; border-radius: 8px; width:100%; margin-bottom:8px; text-align: left; cursor: pointer; font-size: 1rem; }
        .btn-action.priority { border: 2px solid var(--accent); background: #FDEDEC; font-weight: bold; color: var(--accent); }

        /* --- Modals (Z-Index 5000) --- */
        #crisis-overlay, #report-modal, #ending-modal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.9); z-index: 5000;
            display: none; justify-content: center; align-items: center; padding: 20px;
        }
        #crisis-overlay { background: rgba(20, 0, 0, 0.95); }
        .crisis-box { border: 5px solid #E74C3C; padding: 25px; width: 100%; max-width: 500px; background: #000; text-align: center; color: #fff; box-shadow: 0 0 40px #E74C3C; }
        .report-card { background: white; padding: 25px; border-radius: 12px; width: 100%; max-width: 360px; max-height: 85dvh; overflow-y: auto; position:relative; z-index:5001;}
        .report-row { margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 1.1rem; }
        .report-input { width: 60px; padding: 10px; text-align: center; font-size: 1.2rem; border: 1px solid #ccc; background: #f9f9f9; }

        /* --- Bottom Nav --- */
        #bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: calc(var(--nav-height) + env(safe-area-inset-bottom)); background: #fff; border-top: 1px solid #ccc; display: flex; justify-content: space-around; align-items: flex-start; padding-top: 8px; z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; color: #888; flex: 1; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-icon { font-size: 1.2rem; margin-bottom: 2px; }

        #bleed-timer { position: absolute; top: 10px; right: 80px; background: #C0392B; color: white; padding: 4px 8px; font-weight: bold; font-family: monospace; border-radius: 4px; display: none; animation: pulse-red 0.5s infinite; font-size: 1.1rem; }
        @keyframes pulse-red { 0% { opacity: 1; transform:scale(1); } 50% { opacity: 0.7; transform:scale(1.05); } 100% { opacity: 1; transform:scale(1); } }
    </style>
</head>
<body>
    <div id="red-strobe-fx" class="red-strobe"></div>

    <div id="dashboard">
        <div class="dash-icon">ğŸ“Š</div>
        <div class="dash-content">
            <div class="dash-header" id="dash-header"><span>æˆ°æƒ…çœ‹æ¿</span> <span style="font-size:1.2rem;">_</span></div>
            <div class="dash-row"><span style="color:#C0392B">ğŸ”´ Red</span><span id="count-r" style="font-weight:bold">0</span></div>
            <div class="dash-row"><span style="color:#F39C12">ğŸŸ¡ Yellow</span><span id="count-y" style="font-weight:bold">0</span></div>
            <div class="dash-row"><span style="color:#27AE60">ğŸŸ¢ Green</span><span id="count-g" style="font-weight:bold">0</span></div>
            <div class="dash-row"><span style="color:#2C3E50">âš« Black</span><span id="count-b" style="font-weight:bold">0</span></div>
            <div style="margin-top:5px; padding-top:2px; font-size:0.8rem; color:#666;">å¾…è™•ç†: <span id="pending-count">15</span></div>
        </div>
    </div>

    <div id="start-screen">
        <div class="mission-card">
            <h1 style="font-size:1.5rem; margin-bottom:15px; color:var(--primary);">EMT-1 æˆ°è¡“å…µæ¨ V43</h1>
            <p style="color:#666; margin-bottom:20px; line-height:1.6; text-align:left;">
                <strong>ä»»å‹™ä»£è™Ÿï¼š</strong> 1130 ç©ºè¥²äº‹ä»¶<br>
                <strong>å‚·æ‚£ç¸½æ•¸ï¼š</strong> 15 å<br>
                <strong>ä»»å‹™æ™‚é™ï¼š</strong> <span style="color:#C0392B; font-weight:bold;">5 åˆ†é˜ (å£“åŠ›æ¸¬è©¦)</span><br>
                <small style="color:var(--accent)">âš ï¸ åŒ…å«å¼·çƒˆé–ƒå…‰èˆ‡éœ‡å‹•æ•ˆæœã€‚è«‹é–‹å•ŸéŸ³æ•ˆã€‚</small>
            </p>
            <button class="btn-start" onclick="app.startMission()">é–‹å§‹ä»»å‹™ Start</button>
        </div>
    </div>

    <div id="crisis-overlay">
        <div class="crisis-box">
            <div style="font-size:4rem; margin-bottom:10px;">ğŸ’£</div>
            <div style="font-size:2.5rem; font-weight:bold; color:#E74C3C; margin-bottom:10px; text-transform:uppercase; letter-spacing:2px;">INCOMING FIRE</div>
            <div class="crisis-desc" id="crisis-desc" style="font-size:1.4rem; margin-bottom:20px; font-weight:bold;">æ•µè»ç ²ç«è¦†è“‹ï¼ç†±å€ç¦æ­¢é†«ç™‚ï¼</div>
            <div style="background:#333; padding:15px; color:#F1C40F; font-weight:bold; margin-bottom:25px; font-size:1rem; border:1px solid #F1C40F;">TECC æˆ°è¡“æº–å‰‡ï¼š<br>"å¨è„…å¤§æ–¼æ²»ç™‚ã€‚æ²’æœ‰æ©è­·å°±æ²’æœ‰é†«ç™‚ã€‚"</div>
            <button class="btn-action" style="width:100%; justify-content:center; font-weight:bold; font-size:1.3rem; padding:15px; background:#E74C3C; color:white; border:none; box-shadow:0 4px 15px rgba(231,76,60,0.5);" onclick="app.resolveCrisis()">ç«‹å³å°‹æ‰¾æ©è­· (TAKE COVER)</button>
        </div>
    </div>

    <div id="report-modal">
        <div class="report-card">
            <h2 style="text-align:center; color:var(--primary); margin-bottom:10px;">æŒ‡æ®ä¸­å¿ƒå›å ±</h2>
            <p style="text-align:center; color:#666; margin-bottom:25px; font-size:0.85rem;">(è«‹æ‹–æ›³æˆ°æƒ…çœ‹æ¿ä»¥å°ç…§æ•¸æ“š)</p>
            <div class="report-row" style="color:#C0392B;">ğŸ”´ ç´…ç‰Œ (Red): <input type="number" id="rep-r" class="report-input" min="0" inputmode="numeric"></div>
            <div class="report-row" style="color:#F39C12;">ğŸŸ¡ é»ƒç‰Œ (Yellow): <input type="number" id="rep-y" class="report-input" min="0" inputmode="numeric"></div>
            <div class="report-row" style="color:#27AE60;">ğŸŸ¢ ç¶ ç‰Œ (Green): <input type="number" id="rep-g" class="report-input" min="0" inputmode="numeric"></div>
            <div class="report-row" style="color:#2C3E50;">âš« é»‘ç‰Œ (Black): <input type="number" id="rep-b" class="report-input" min="0" inputmode="numeric"></div>
            <button class="btn-action" style="width:100%; justify-content:center; background:var(--primary); color:white; font-weight:bold; margin-top:20px;" onclick="app.submitReport()">ç™¼é€å›å ± (Send)</button>
        </div>
    </div>

    <div id="ending-modal">
        <div class="report-card" style="max-width:600px;">
            <div id="ending-title" style="font-size:1.5rem; font-weight:bold; margin-bottom:15px; text-align:center;"></div>
            <div id="ending-body" style="color:#555; line-height:1.6; margin-bottom:20px;"></div>
            <div style="font-weight:bold; margin-bottom:10px; color:var(--primary);">è©³ç´°æª¢è¨å ±å‘Š (AAR):</div>
            <div id="ending-review" style="max-height:300px; overflow-y:auto; border:1px solid #ddd; padding:10px; border-radius:4px; font-size:0.9rem;"></div>
            <button class="btn-action" style="margin-top:20px; justify-content:center; background:var(--primary); color:white;" onclick="app.reset()">é‡æ–°é–‹å§‹ (Restart)</button>
        </div>
    </div>

    <header><h1>EMT-1 æˆ°è¡“å…µæ¨ V43</h1><div class="top-right-controls"><button id="mute-toggle" class="mute-btn" onclick="audioSys.toggleMute()">ğŸ”Š</button></div></header>

    <main id="main-container">
        <div id="scene-view">
            <div id="mission-timer">05:00</div>
            <div class="map-grid" id="map-container">
                <div class="map-obj zone-a">ZONE A (å•†å ´)</div>
                <div class="map-obj zone-b">ZONE B (å…¬è»Š)</div>
                <div class="map-obj zone-c">ZONE C (åœ°ä¸‹å®¤)</div>
            </div>
            <div class="broadcast-fab" onclick="app.broadcastGreen()" id="btn-broadcast">ğŸ“¢</div>
        </div>

        <div id="patient-view">
            <div class="pv-header">
                <span id="case-title" style="font-weight:bold; font-family:'Roboto Mono';">CASE: ???</span>
                <div id="bleed-timer">60s</div>
                <button onclick="app.returnToScene()" style="padding:6px 12px; border:1px solid #999; background:#fff; cursor:pointer; border-radius:4px; font-weight:bold;">â†© æ’¤é›¢</button>
            </div>
            <div class="pv-content-scroll">
                <div class="body-container">
                    <svg viewBox="0 0 200 450" xmlns="http://www.w3.org/2000/svg" style="height:100%; width:auto;">
                        <circle id="part-head" class="body-part" cx="100" cy="50" r="35" onclick="app.assessPart('head')"/>
                        <path id="part-chest" class="body-part" d="M 65 90 L 135 90 L 130 160 L 70 160 Z" onclick="app.assessPart('chest')"/>
                        <path id="part-abdomen" class="body-part" d="M 70 160 L 130 160 L 125 210 L 75 210 Z" onclick="app.assessPart('abdomen')"/>
                        <rect id="part-arm-l" class="body-part" x="25" y="95" width="35" height="110" rx="10" onclick="app.assessPart('arm_l')"/>
                        <rect id="part-arm-r" class="body-part" x="140" y="95" width="35" height="110" rx="10" onclick="app.assessPart('arm_r')"/>
                        <rect id="part-leg-l" class="body-part" x="65" y="215" width="32" height="160" rx="10" onclick="app.assessPart('leg_l')"/>
                        <rect id="part-leg-r" class="body-part" x="103" y="215" width="32" height="160" rx="10" onclick="app.assessPart('leg_r')"/>
                    </svg>
                    <div id="body-overlays"></div>
                </div>
                <div class="info-panel">
                    <div id="log-display" class="assessment-log"><div class="log-entry">ç³»çµ±å°±ç·’ã€‚è«‹é»é¸èº«é«”éƒ¨ä½è©•ä¼°ã€‚</div></div>
                    <div id="action-panel" style="display:flex; flex-direction:column; gap:8px;"></div>
                </div>
            </div>
            <div id="triage-bar">
                <button class="btn-triage red" onclick="app.tagPatient('Red')">ç´… Red</button>
                <button class="btn-triage yellow" onclick="app.tagPatient('Yellow')">é»ƒ Yellow</button>
                <button class="btn-triage green" onclick="app.tagPatient('Green')">ç¶  Green</button>
                <button class="btn-triage black" onclick="app.tagPatient('Black')">é»‘ Black</button>
            </div>
        </div>
    </main>

    <div id="bottom-nav">
        <div class="nav-item active" onclick="app.switchTab('map')"><div class="nav-icon">ğŸ—ºï¸</div><div>ç¾å ´åœ°åœ–</div></div>
        <div class="nav-item" onclick="app.switchTab('patient')"><div class="nav-icon">ğŸš‘</div><div>å‚·æ‚£è™•ç½®</div></div>
        <div class="nav-item" onclick="audioSys.toggleMute()"><div class="nav-icon">ğŸ”Š</div><div>éœéŸ³åˆ‡æ›</div></div>
    </div>

    <script>
        // --- DATA ---
        const CASES_INIT = [
            { id: "MCI-01", type: "Black", title: "Cå€-è¢«æ°´æ³¥å£“ä½", findings: { head: {text:"é ­é¡±è®Šå½¢ï¼Œè…¦çµ„ç¹”å¤–æº¢", icon:"ğŸ’€"}, chest: {text:"ç„¡èµ·ä¼", icon:""}, abdomen: {text:"ç„¡æ³•è©•ä¼°", icon:""}, arm_l: {text:"ç„¡åæ‡‰", icon:""}, arm_r: {text:"ç„¡åæ‡‰", icon:""}, leg_l: {text:"è¢«å£“ä½", icon:""}, leg_r: {text:"è¢«å£“ä½", icon:""} }, is_x: false, feedback: "è…¦çµ„ç¹”å¤–æº¢ç‚ºæ˜é¡¯æ­»äº¡å¾µè±¡ (DOA)ã€‚", actions_needed: [] },
            { id: "MCI-02", type: "Red", title: "Bå€-å‘¼å¸æ€¥ä¿ƒ", findings: { head: {text:"å£é¼»ç¢³ç²’ï¼Œå–˜é³´è²", icon:"ğŸ”¥"}, chest: {text:"å‘¼å¸32æ¬¡/åˆ†ï¼Œè²»åŠ›", icon:"âš ï¸"}, abdomen: {text:"ç„¡å¤–å‚·", icon:""}, arm_l: {text:"äºŒåº¦ç‡’å‚·", icon:""}, arm_r: {text:"äºŒåº¦ç‡’å‚·", icon:""}, leg_l: {text:"ç„¡å¤–å‚·", icon:""}, leg_r: {text:"ç„¡å¤–å‚·", icon:""} }, is_x: false, feedback: "å‘¼å¸é€Ÿç‡ > 30 ä¸”å‘¼å¸é“ç¼å‚·ï¼Œå„ªå…ˆç´…ç‰Œã€‚", actions_needed: ["opa"] },
            { id: "MCI-03", type: "Red", title: "Bå€-å¤§å‡ºè¡€", findings: { head: {text:"å°–å«å‘¼æ•‘", icon:"ğŸ˜¨"}, chest: {text:"å‘¼å¸26æ¬¡/åˆ†ï¼Œè’¼ç™½", icon:""}, abdomen: {text:"ç„¡å¤–å‚·", icon:""}, arm_l: {text:"ç„¡å¤–å‚·", icon:""}, arm_r: {text:"ç„¡å¤–å‚·", icon:""}, leg_l: {text:"ç„¡å¤–å‚·", icon:""}, leg_r: {text:"ğŸ©¸ å³è…¿æˆªè‚¢å™´è¡€ï¼", icon:"ğŸ©¸", is_x: true} }, is_x: true, death_timer: 45, feedback: "å‹•è„ˆå¤§å‡ºè¡€ï¼Œæœªç«‹å³æ­¢è¡€å°è‡´æ­»äº¡ã€‚", actions_needed: ["tq"] },
            { id: "MCI-04", type: "Red", title: "Cå€-åŠæ©åŸ‹", findings: { head: {text:"æ„è­˜ä¸æ¸…(GCS 9)", icon:"ğŸ¥´"}, chest: {text:"å‘¼å¸æ·ºå¿« 8æ¬¡/åˆ†", icon:""}, abdomen: {text:"å£“ç—›", icon:""}, arm_l: {text:"æ“¦å‚·", icon:""}, arm_r: {text:"æ“¦å‚·", icon:""}, leg_l: {text:"è¢«ç“¦ç¤«å£“ä½", icon:""}, leg_r: {text:"è¢«ç“¦ç¤«å£“ä½", icon:""} }, is_x: false, feedback: "æ„è­˜ä¸æ¸… (GCS<10) ç‚ºç´…ç‰Œã€‚", actions_needed: ["opa"] },
            { id: "MCI-05", type: "Yellow", title: "Aå€-åè‘—æ‰‹ç—›", findings: { head: {text:"æ„è­˜æ¸…æ¥šï¼Œä¸»è¨´æ‰‹ç—›", icon:"ğŸ™‚"}, chest: {text:"å‘¼å¸20æ¬¡/åˆ†", icon:""}, abdomen: {text:"è»Ÿ", icon:""}, arm_l: {text:"è®Šå½¢ï¼Œç„¡å¤§å‡ºè¡€", icon:"ğŸ¦´"}, arm_r: {text:"ç„¡", icon:""}, leg_l: {text:"å‰²å‚·", icon:""}, leg_r: {text:"ç„¡", icon:""} }, is_x: false, feedback: "ç„¡æ³•è¡Œèµ°ä½†å¾µè±¡ç©©å®šï¼Œé»ƒç‰Œã€‚", actions_needed: [] },
            { id: "MCI-06", type: "Yellow", title: "Aå€-èƒ¸ç—›", findings: { head: {text:"æ„è­˜æ¸…æ¥š", icon:""}, chest: {text:"å‰èƒ¸æŒ«å‚·ï¼Œå‘¼å¸22æ¬¡/åˆ†", icon:"ğŸ©¹"}, abdomen: {text:"è»Ÿ", icon:""}, arm_l: {text:"ç„¡", icon:""}, arm_r: {text:"ç„¡", icon:""}, leg_l: {text:"ç„¡", icon:""}, leg_r: {text:"ç„¡", icon:""} }, is_x: false, feedback: "èƒ¸éƒ¨æŒ«å‚·ä½†å‘¼å¸æ­£å¸¸ï¼Œé»ƒç‰Œã€‚", actions_needed: [] },
            { id: "MCI-07", type: "Yellow", title: "Bå€-è·Œå", findings: { head: {text:"ç—›è‹¦è¡¨æƒ…", icon:""}, chest: {text:"å‘¼å¸20æ¬¡/åˆ†", icon:""}, abdomen: {text:"éª¨ç›†æ“ å£“ç—›", icon:"âš¡"}, arm_l: {text:"ç„¡", icon:""}, arm_r: {text:"ç„¡", icon:""}, leg_l: {text:"ç„¡", icon:""}, leg_r: {text:"ç„¡", icon:""} }, is_x: false, feedback: "éª¨ç›†éª¨æŠ˜ï¼Œé»ƒç‰Œã€‚", actions_needed: [] },
            { id: "MCI-08", type: "Yellow", title: "Aå€-æ‘€è‚šå­", findings: { head: {text:"å†’å†·æ±—", icon:""}, chest: {text:"å‘¼å¸24æ¬¡/åˆ†", icon:""}, abdomen: {text:"è…¸é“å¤–éœ²", icon:"ğŸŒ­"}, arm_l: {text:"ç„¡", icon:""}, arm_r: {text:"ç„¡", icon:""}, leg_l: {text:"ç„¡", icon:""}, leg_r: {text:"ç„¡", icon:""} }, is_x: false, feedback: "è‡Ÿå™¨å¤–éœ²ï¼Œéœ€è¦†è“‹ï¼Œé»ƒç‰Œã€‚", actions_needed: ["gut"] },
            { id: "MCI-09", type: "Red", title: "Bå€-å‘¼å¸å›°é›£", findings: { head: {text:"ç„¦èºä¸å®‰", icon:"ğŸ˜°"}, chest: {text:"å–®å´å‘¼å¸éŸ³æ¶ˆå¤±ï¼Œå‘¼å¸36æ¬¡", icon:"ğŸ“‰"}, abdomen: {text:"è»Ÿ", icon:""}, arm_l: {text:"ç„¡", icon:""}, arm_r: {text:"ç„¡", icon:""}, leg_l: {text:"ç„¡", icon:""}, leg_r: {text:"ç„¡", icon:""} }, is_x: false, crisis_mode: true, feedback: "å¼µåŠ›æ€§æ°£èƒ¸å¾µè±¡ï¼Œç´…ç‰Œã€‚", actions_needed: [] },
            { id: "MCI-10", type: "Green", title: "Aå€-èµ°å‹•", findings: { head: {text:"æ¸…æ¥š", icon:""}, chest: {text:"æ­£å¸¸", icon:""}, abdomen: {text:"è»Ÿ", icon:""}, arm_l: {text:"æ“¦å‚·", icon:""}, arm_r: {text:"ç„¡", icon:""}, leg_l: {text:"ç„¡", icon:""}, leg_r: {text:"ç„¡", icon:""} }, is_x: false, feedback: "ç¶ ç‰Œã€‚", actions_needed: [] },
            { id: "MCI-11", type: "Green", title: "Aå€-èµ°å‹•", findings: { head: {text:"æ¸…æ¥š", icon:""}, chest: {text:"æ­£å¸¸", icon:""}, abdomen: {text:"è»Ÿ", icon:""}, arm_l: {text:"ç„¡", icon:""}, arm_r: {text:"æ‰­å‚·", icon:""}, leg_l: {text:"ç„¡", icon:""}, leg_r: {text:"ç„¡", icon:""} }, is_x: false, feedback: "ç¶ ç‰Œã€‚", actions_needed: [] },
            { id: "MCI-12", type: "Green", title: "Aå€-é©šåš‡", findings: { head: {text:"å“­æ³£", icon:"ğŸ˜­"}, chest: {text:"å¿«ä½†æ­£å¸¸", icon:""}, abdomen: {text:"è»Ÿ", icon:""}, arm_l: {text:"ç„¡", icon:""}, arm_r: {text:"ç„¡", icon:""}, leg_l: {text:"ç„¡", icon:""}, leg_r: {text:"ç„¡", icon:""} }, is_x: false, feedback: "ç¶ ç‰Œã€‚", actions_needed: [] },
            { id: "MCI-13", type: "Green", title: "Aå€-èµ°å‹•", findings: { head: {text:"æ¸…æ¥š", icon:""}, chest: {text:"æ­£å¸¸", icon:""}, abdomen: {text:"è»Ÿ", icon:""}, arm_l: {text:"ç„¡", icon:""}, arm_r: {text:"ç„¡", icon:""}, leg_l: {text:"æ“¦å‚·", icon:""}, leg_r: {text:"ç„¡", icon:""} }, is_x: false, feedback: "ç¶ ç‰Œã€‚", actions_needed: [] },
            { id: "MCI-14", type: "Green", title: "Aå€-å€’åœ°", findings: { head: {text:"æŠ½æä¸­", icon:"âš¡"}, chest: {text:"æ·ºå¿«", icon:""}, abdomen: {text:"è»Ÿ", icon:""}, arm_l: {text:"æŠ½æ", icon:""}, arm_r: {text:"æŠ½æ", icon:""}, leg_l: {text:"æŠ½æ", icon:""}, leg_r: {text:"æŠ½æ", icon:""} }, is_x: false, crisis_mode: true, feedback: "ç™²ç™‡ç™¼ä½œæ„è­˜ä¸æ¸…ï¼Œç´…ç‰Œã€‚", actions_needed: ["opa"] },
            { id: "MCI-15", type: "Green", title: "Aå€-èµ°å‹•", findings: { head: {text:"æ¸…æ¥š", icon:""}, chest: {text:"æ­£å¸¸", icon:""}, abdomen: {text:"è»Ÿ", icon:""}, arm_l: {text:"ç„¡", icon:""}, arm_r: {text:"ç„¡", icon:""}, leg_l: {text:"ç„¡", icon:""}, leg_r: {text:"æ‰­å‚·", icon:""} }, is_x: false, feedback: "ç¶ ç‰Œã€‚", actions_needed: [] }
        ];

        let CASES = JSON.parse(JSON.stringify(CASES_INIT));

        const app = {
            state: {
                currentCase: null, assessedParts: [], log: [], x_treated: false, inCrisis: false, completedIds: [],
                userDecisions: {}, userActions: {}, greenBroadcasted: false, timerId: null, deathCountdown: 0, isDead: false,
                triageCounts: { Red: 0, Yellow: 0, Green: 0, Black: 0 }, missionTime: 300, missionTimerId: null, crisisTimerId: null
            },

            init: function() { this.initDraggable(); },

            reset: function() {
                CASES = JSON.parse(JSON.stringify(CASES_INIT));
                this.state = {
                    currentCase: null, assessedParts: [], log: [], x_treated: false, inCrisis: false, completedIds: [],
                    userDecisions: {}, userActions: {}, greenBroadcasted: false, timerId: null, deathCountdown: 0, isDead: false,
                    triageCounts: { Red: 0, Yellow: 0, Green: 0, Black: 0 }, missionTime: 300, missionTimerId: null, crisisTimerId: null
                };
                document.getElementById('ending-modal').style.display = 'none';
                document.getElementById('start-screen').style.display = 'flex';
                document.getElementById('dashboard').classList.remove('expanded');
                ['r','y','g','b'].forEach(k => document.getElementById(`count-${k}`).innerText = "0");
                document.getElementById('pending-count').innerText = "15";
                const dash = document.getElementById('dashboard');
                dash.style.left = '20px'; dash.style.top = '80px';
            },

            startMission: function() {
                audioSys.init(); 
                document.getElementById('start-screen').style.display = 'none';
                this.renderSceneMap();
                this.startMissionTimer();
                this.startCrisisEngine();
            },

            initDraggable: function() {
                const dash = document.getElementById('dashboard');
                const handleOpen = document.getElementById('dash-header');
                const handleClosed = dash.querySelector('.dash-icon');
                let isDragging = false, startX, startY, initialLeft, initialTop;

                const toggle = () => { if(!isDragging) dash.classList.toggle('expanded'); };
                handleClosed.addEventListener('click', toggle);
                handleOpen.querySelector('span:last-child').addEventListener('click', (e) => { e.stopPropagation(); toggle(); });

                const onDown = (e) => {
                    const evt = e.touches ? e.touches[0] : e;
                    startX = evt.clientX; startY = evt.clientY;
                    initialLeft = dash.offsetLeft; initialTop = dash.offsetTop;
                    isDragging = false;
                    document.addEventListener('mousemove', onMove); document.addEventListener('touchmove', onMove, {passive:false});
                    document.addEventListener('mouseup', onUp); document.addEventListener('touchend', onUp);
                };
                const onMove = (e) => {
                    const evt = e.touches ? e.touches[0] : e;
                    if (Math.abs(evt.clientX - startX) > 5 || Math.abs(evt.clientY - startY) > 5) {
                        isDragging = true; 
                        if(e.cancelable) e.preventDefault();
                    }
                    if (isDragging) {
                        let l = initialLeft + (evt.clientX - startX);
                        let t = initialTop + (evt.clientY - startY);
                        dash.style.left = Math.max(0, Math.min(l, window.innerWidth - dash.offsetWidth)) + 'px';
                        dash.style.top = Math.max(0, Math.min(t, window.innerHeight - dash.offsetHeight)) + 'px';
                    }
                };
                const onUp = () => {
                    document.removeEventListener('mousemove', onMove); document.removeEventListener('touchmove', onMove);
                    document.removeEventListener('mouseup', onUp); document.removeEventListener('touchend', onUp);
                    setTimeout(() => isDragging = false, 100);
                };
                handleClosed.addEventListener('mousedown', onDown); handleClosed.addEventListener('touchstart', onDown, {passive:false});
                handleOpen.addEventListener('mousedown', onDown); handleOpen.addEventListener('touchstart', onDown, {passive:false});
            },

            renderSceneMap: function() {
                document.getElementById('scene-view').style.display = 'block';
                document.getElementById('patient-view').style.display = 'none';
                document.getElementById('triage-bar').style.display = 'none';
                
                const total = 15; const done = this.state.completedIds.length;
                document.getElementById('pending-count').innerText = total - done;
                if (done === total) { this.showFinalReport(); return; }

                const map = document.getElementById('map-container');
                map.querySelectorAll('.patient-dot').forEach(e => e.remove());
                
                const slots = [
                    {t: 10, l: 10}, {t: 10, l: 30}, {t: 25, l: 10}, {t: 25, l: 30}, {t: 40, l: 20},
                    {t: 10, l: 60}, {t: 10, l: 80}, {t: 30, l: 60}, {t: 30, l: 80}, {t: 20, l: 70},
                    {t: 60, l: 15}, {t: 60, l: 45}, {t: 60, l: 75}, {t: 75, l: 30}, {t: 75, l: 60}
                ];

                CASES.forEach((c, idx) => {
                    if (this.state.completedIds.includes(c.id)) return;
                    const dot = document.createElement('div');
                    dot.className = 'patient-dot';
                    dot.innerText = `P${idx+1}`;
                    let pos = slots[idx % slots.length];
                    dot.style.top = (pos.t + (Math.random()-0.5)*3) + '%';
                    dot.style.left = (pos.l + (Math.random()-0.5)*3) + '%';
                    
                    // KEY FIX: Use dataset to bind ID, avoid closure issues
                    dot.dataset.caseId = c.id; 

                    if (this.state.greenBroadcasted && c.type === 'Green' && c.id !== 'MCI-14') {
                        dot.classList.add('green-walk');
                        setTimeout(() => {
                            if(!this.state.completedIds.includes(c.id)) {
                                this.updateTriageCount('Green');
                                this.state.completedIds.push(c.id);
                                this.state.userDecisions[c.id] = 'Green'; 
                                dot.remove(); this.renderSceneMap();
                            }
                        }, 800);
                    } else {
                        // KEY FIX: Read ID from event target
                        dot.addEventListener('click', (e) => {
                            const id = e.currentTarget.dataset.caseId;
                            this.enterCase(id);
                        });
                    }
                    map.appendChild(dot);
                });
            },

            clearPatientState: function() {
                this.state.currentCase = null;
                this.state.assessedParts = [];
                this.state.log = [];
                this.state.x_treated = false;
                this.state.isDead = false;
                document.querySelectorAll('.body-part').forEach(el => {
                    el.classList.remove('assessed', 'injured', 'critical-x');
                });
                document.getElementById('body-overlays').innerHTML = '';
                if(this.state.timerId) clearInterval(this.state.timerId);
                document.getElementById('bleed-timer').style.display = 'none';
            },

            enterCase: function(caseId) {
                // HARD RESET before loading new case
                this.clearPatientState();

                const c = CASES.find(x => x.id === caseId);
                if (!c) { console.error("Case not found:", caseId); return; }

                this.state.currentCase = c; // Set new case
                this.state.log = [`>> æ¥è§¸å‚·æ‚£: ${c.title}`];
                if(!this.state.userActions[c.id]) this.state.userActions[c.id] = [];
                
                document.getElementById('scene-view').style.display = 'none';
                document.getElementById('patient-view').style.display = 'flex';
                document.getElementById('triage-bar').style.display = 'grid'; 
                document.getElementById('case-title').innerText = `CASE: ${c.id}`;
                
                // Bleeding Timer
                if (c.death_timer) {
                    this.state.deathCountdown = c.death_timer;
                    document.getElementById('bleed-timer').style.display = 'block';
                    document.getElementById('bleed-timer').innerText = `${this.state.deathCountdown}s`;
                    this.state.timerId = setInterval(() => {
                        if (this.state.x_treated || this.state.isDead) { clearInterval(this.state.timerId); return; }
                        this.state.deathCountdown--;
                        document.getElementById('bleed-timer').innerText = `${this.state.deathCountdown}s`;
                        if (this.state.deathCountdown <= 0) this.triggerDeath("å¤±è¡€éå¤š");
                    }, 1000);
                }

                // Initial Critical Signs
                if (c.is_x) {
                    const xKey = Object.keys(c.findings).find(k => c.findings[k].is_x);
                    if(xKey) {
                        document.getElementById(`part-${xKey}`).classList.add('critical-x');
                        this.log(`âš ï¸ ç™¼ç¾å¤§é‡å‡ºè¡€ï¼`, 'warn');
                    }
                }
                this.updateLog(); this.renderActions();
            },

            returnToScene: function() {
                this.clearPatientState(); // Ensure state is wiped on exit
                document.getElementById('triage-bar').style.display = 'none';
                this.renderSceneMap();
            },

            assessPart: function(partId) {
                if (this.state.inCrisis || this.state.isDead || !this.state.currentCase) return;
                const c = this.state.currentCase;
                const data = c.findings[partId];
                
                const hasX = Object.values(c.findings).some(f => f.is_x);
                if (hasX && !this.state.x_treated && !data.is_x) {
                    this.log(`âŒ é•å TECCï¼æ‡‰å„ªå…ˆè™•ç†å¤§å‡ºè¡€ï¼`, 'warn');
                    audioSys.playTone('wrong');
                    return;
                }

                if (!this.state.assessedParts.includes(partId)) {
                    this.state.assessedParts.push(partId);
                    const el = document.getElementById(`part-${partId}`);
                    el.classList.add('assessed');
                    if (data.text.match(/å‚·|è¡€|ç—›|è®Šå½¢|ç‡’|ç„¡åæ‡‰/)) el.classList.add('injured');
                    this.showFloatingLabel(el, data.text);
                    this.log(`ğŸ” ${data.text}`);
                }
                this.renderActions();
            },

            showFloatingLabel: function(el, text) {
                const label = document.createElement('div');
                label.className = 'finding-label';
                label.innerText = text;
                const id = el.id;
                const posMap = { 'head':['10%','50%'], 'chest':['25%','50%'], 'abdomen':['40%','50%'], 'leg':['70%','50%'], 'arm':['30%','20%'] };
                let k = Object.keys(posMap).find(key => id.includes(key)) || 'chest';
                label.style.top = posMap[k][0]; label.style.left = posMap[k][1];
                label.style.transform = 'translateX(-50%)';
                document.getElementById('body-overlays').appendChild(label);
                setTimeout(() => label.remove(), 2500);
            },

            performAction: function(act) {
                const c = this.state.currentCase;
                if(!c) return;
                if(!this.state.userActions[c.id].includes(act)) this.state.userActions[c.id].push(act);
                if (act === 'tq') {
                    this.state.x_treated = true;
                    if(this.state.timerId) clearInterval(this.state.timerId); 
                    document.getElementById('bleed-timer').style.display = 'none';
                    this.log(`âœ… æ­¢è¡€å¸¶å·²ä½¿ç”¨ã€‚`, 'action');
                    document.querySelectorAll('.critical-x').forEach(el => el.classList.remove('critical-x'));
                    this.renderActions();
                } else if (act === 'opa') {
                    this.log(c.findings.head.text.includes('æ¸…æ¥š') ? `âŒ å‚·æ‚£æ’æ–¥ OPAï¼` : `âœ… OPA ç½®å…¥æˆåŠŸã€‚`, c.findings.head.text.includes('æ¸…æ¥š') ? 'warn' : 'action');
                } else if (act === 'gut') {
                    this.log(`âœ… æ¿•æ•·æ–™å·²è¦†è“‹ã€‚`, 'action');
                }
            },

            renderActions: function() {
                const panel = document.getElementById('action-panel');
                panel.innerHTML = '';
                const c = this.state.currentCase;
                if (!c || this.state.isDead) return;

                if (c.is_x && !this.state.x_treated && this.state.assessedParts.length > 0) {
                     panel.innerHTML += `<button class="btn-action priority" onclick="app.performAction('tq')">ğŸ©¸ ä½¿ç”¨æ­¢è¡€å¸¶ (CAT)</button>`;
                     return;
                }
                if (this.state.assessedParts.includes('head')) {
                    panel.innerHTML += `<button class="btn-action" onclick="app.performAction('opa')">ğŸ« ç½®å…¥å£å’½å‘¼å¸é“ (OPA)</button>`;
                }
                if (c.findings.abdomen.text.includes('è…¸')) panel.innerHTML += `<button class="btn-action" onclick="app.performAction('gut')">ğŸ©¹ æ¿•æ½¤æ•·æ–™è¦†è“‹</button>`;
            },

            tagPatient: function(color) {
                const c = this.state.currentCase;
                if(!c) return;
                this.state.completedIds.push(c.id);
                this.state.userDecisions[c.id] = color;
                this.updateTriageCount(color);
                this.returnToScene();
            },

            updateTriageCount: function(color) {
                this.state.triageCounts[color]++;
                document.getElementById(`count-${color.charAt(0).toLowerCase()}`).innerText = this.state.triageCounts[color];
            },

            switchTab: function(tab) {
                if(tab === 'map') this.returnToScene();
                else if(this.state.currentCase && !this.state.completedIds.includes(this.state.currentCase.id)) {
                    document.getElementById('scene-view').style.display = 'none';
                    document.getElementById('patient-view').style.display = 'flex';
                    document.getElementById('triage-bar').style.display = 'grid'; 
                }
            },

            broadcastGreen: function() {
                if(this.state.greenBroadcasted) return;
                this.state.greenBroadcasted = true;
                const btn = document.getElementById('btn-broadcast');
                btn.innerHTML = "âœ…"; btn.style.background = "#7f8c8d";
                audioSys.playTone('correct');
                this.renderSceneMap();
            },

            startMissionTimer: function() {
                if(this.state.missionTimerId) clearInterval(this.state.missionTimerId);
                this.state.missionTimerId = setInterval(() => {
                    this.state.missionTime--;
                    const m = Math.floor(this.state.missionTime / 60);
                    const s = this.state.missionTime % 60;
                    document.getElementById('mission-timer').innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                    if(this.state.missionTime <= 0) {
                        clearInterval(this.state.missionTimerId);
                        alert("æ™‚é–“åˆ°ï¼åœæ­¢æ‰€æœ‰å‹•ä½œï¼");
                        this.showFinalReport();
                    }
                }, 1000);
            },

            startCrisisEngine: function() {
                if(this.state.crisisTimerId) clearInterval(this.state.crisisTimerId);
                this.state.crisisTimerId = setInterval(() => { this.triggerRandomCrisis(); }, 20000); 
            },

            triggerRandomCrisis: function() {
                if (this.state.inCrisis || this.state.missionTime < 30) return;
                
                // Increase crisis chance for stress
                if (Math.random() < 0.35) {
                    this.state.inCrisis = true;
                    this.triggerAirRaid();
                } 
                else if (Math.random() < 0.5 && this.state.currentCase && this.state.currentCase.crisis_mode) {
                     this.log(`ğŸš¨ å‚·æ‚£ç—…æƒ…æ€¥é½æƒ¡åŒ–ï¼`, 'warn');
                     this.state.currentCase.type = 'Red';
                     audioSys.playTone('wrong');
                     document.body.classList.add('screen-shake');
                     setTimeout(()=>document.body.classList.remove('screen-shake'), 500);
                }
            },

            triggerAirRaid: function() {
                audioSys.playTone('alarm');
                document.body.classList.add('screen-shake');
                document.getElementById('red-strobe-fx').style.display = 'block'; // Red Flash
                document.getElementById('crisis-overlay').style.display = 'flex';
                
                // PUNISHMENT: If in patient view, you die.
                if (document.getElementById('patient-view').style.display !== 'none') {
                    // Slight delay to allow realization
                    setTimeout(() => {
                        if(this.state.inCrisis) { // If still in crisis and viewing patient
                             alert("ğŸ’€ æ‚¨å·²é™£äº¡ (K.I.A)\n\nåŸå› ï¼šç©ºè¥²æœŸé–“æœªç«‹å³æ’¤é›¢ç†±å€ï¼Œé­ç ´ç‰‡æ“Šä¸­ã€‚\n\næ•™è¨“ï¼šTECC ç¬¬ä¸€åŸå‰‡ - æ¶æ•‘å‚·æ‚£å‰ï¼Œå…ˆç¢ºä¿è‡ªèº«å­˜æ´»ã€‚");
                             location.reload(); // Hard Game Over
                        }
                    }, 4000); // 4 seconds grace period to click "Take Cover"
                }
            },

            resolveCrisis: function() {
                document.getElementById('crisis-overlay').style.display = 'none';
                document.getElementById('red-strobe-fx').style.display = 'none';
                document.body.classList.remove('screen-shake');
                this.state.inCrisis = false;
                
                // If user clicked "Take Cover", forced retreat
                if (document.getElementById('patient-view').style.display !== 'none') {
                    this.returnToScene();
                }

                // Penalty for M-03 if delayed
                const p3 = CASES.find(c => c.id === 'MCI-03');
                if (!this.state.completedIds.includes('MCI-03') && !this.state.x_treated) {
                    p3.type = 'Black'; p3.feedback = "å› ç©ºè¥²å»¶èª¤æ­¢è¡€ï¼Œå‚·æ‚£å·²æ­»äº¡ã€‚";
                }
            },

            triggerDeath: function(reason) {
                if (this.state.timerId) clearInterval(this.state.timerId);
                this.state.isDead = true;
                this.state.currentCase.type = 'Black'; 
                this.state.currentCase.feedback = `å‚·æ‚£å› ${reason}æ­»äº¡ã€‚`;
                this.log(`ğŸ’€ å‚·æ‚£${reason}ï¼ŒOHCAã€‚`, 'death');
                audioSys.playTone('wrong');
                this.renderActions();
            },

            log: function(msg, type='') {
                this.state.log.push(msg);
                const el = document.getElementById('log-display');
                el.innerHTML = this.state.log.map(t => `<div class="log-entry ${type.includes('warn')?'warn':''}">${t}</div>`).join('');
                el.scrollTop = el.scrollHeight;
            },

            showFinalReport: function() {
                document.getElementById('scene-view').style.display = 'none';
                document.getElementById('patient-view').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block'; 
                document.getElementById('dashboard').classList.add('expanded');
                document.getElementById('report-modal').style.display = 'flex';
                clearInterval(this.state.missionTimerId);
                clearInterval(this.state.crisisTimerId);
            },

            submitReport: function() {
                const r = parseInt(document.getElementById('rep-r').value) || 0;
                const y = parseInt(document.getElementById('rep-y').value) || 0;
                const g = parseInt(document.getElementById('rep-g').value) || 0;
                const b = parseInt(document.getElementById('rep-b').value) || 0;
                if ((r+y+g+b) !== 15) { alert("äººæ•¸ä¸ç¬¦ (æ‡‰ç‚º15)ï¼"); return; }
                this.generateEnding();
            },

            generateEnding: function() {
                document.getElementById('report-modal').style.display = 'none';
                document.getElementById('dashboard').style.display = 'none';
                const modal = document.getElementById('ending-modal');
                const review = document.getElementById('ending-review');
                
                let correctCount = 0; let criticalFail = false; let reviewHtml = "";
                CASES.forEach(c => {
                    const user = this.state.userDecisions[c.id];
                    const actions = this.state.userActions[c.id] || [];
                    let missing = [];
                    if(c.actions_needed) c.actions_needed.forEach(req => { if(!actions.includes(req)) missing.push(req); });

                    if (user === c.type && missing.length === 0) {
                        correctCount++;
                        reviewHtml += `<div style="color:#27AE60; border-bottom:1px solid #eee; padding:5px;">âœ… ${c.id}: å®Œç¾è™•ç½®</div>`;
                    } else {
                        if (c.type === 'Red' && user === 'Green') criticalFail = true;
                        reviewHtml += `<div style="color:#C0392B; border-bottom:1px solid #eee; padding:5px;">âŒ ${c.id}: æ‚¨çš„åˆ¤æ–· ${user || 'æœªæª¢å‚·'} (æ‡‰ç‚º ${c.type})<br><small>${c.feedback} ${missing.length?'æœªè™•ç½®:'+missing.join(','):''}</small></div>`;
                    }
                });

                review.innerHTML = reviewHtml;
                modal.style.display = 'flex';
                const title = document.getElementById('ending-title');
                const body = document.getElementById('ending-body');

                if (correctCount === 15) {
                    title.innerText = "ğŸ† æˆ°è¡“å¤§å¸«"; title.style.color = "#27AE60";
                    body.innerHTML = "å®Œç¾é”æˆä»»å‹™ï¼æ‚¨åœ¨æ¥µé«˜å£“ç’°å¢ƒä¸‹å±•ç¾äº†ç²¾æº–çš„ TECC åˆ¤æ–·ã€‚";
                } else if (criticalFail) {
                    title.innerText = "ğŸ’€ ä»»å‹™å¤±æ•—"; title.style.color = "#C0392B";
                    body.innerHTML = "ç™¼ç”Ÿåš´é‡æª¢å‚·éŒ¯èª¤ï¼ˆç´…ç‰Œèª¤åˆ¤ç‚ºç¶ ç‰Œï¼‰ï¼Œå°è‡´å‚·æ‚£æ­»äº¡ã€‚";
                } else {
                    title.innerText = `âš ï¸ å®Œæˆæ¼”ç·´ (${correctCount}/15)`; title.style.color = "#F39C12";
                    body.innerHTML = "æ‚¨åœ¨å£“åŠ›ä¸‹å®Œæˆä»»å‹™ï¼Œä½†éƒ¨åˆ†å‚·æ‚£è™•ç½®æˆ–åˆ†é¡æœ‰èª¤ã€‚è«‹åƒè€ƒä¸‹æ–¹æª¢è¨ã€‚";
                }
            }
        };

        const audioSys = {
            ctx: null,
            init: function() {
                if(!this.ctx) { const AC = window.AudioContext || window.webkitAudioContext; if(AC) this.ctx = new AC(); }
                if(this.ctx && this.ctx.state === 'suspended') this.ctx.resume();
            },
            toggleMute: function() { if(this.ctx) this.ctx.state==='suspended'?this.ctx.resume():this.ctx.suspend(); },
            playTone: function(type) {
                if (!this.ctx) return;
                const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
                o.connect(g); g.connect(this.ctx.destination);
                const t = this.ctx.currentTime;
                if (type === 'alarm') {
                    // Stuttering Alarm
                    o.type = 'sawtooth'; o.frequency.setValueAtTime(800, t); 
                    g.gain.setValueAtTime(0.5, t); g.gain.setValueAtTime(0, t+0.1);
                    g.gain.setValueAtTime(0.5, t+0.2); g.gain.setValueAtTime(0, t+0.3);
                    o.start(t); o.stop(t+0.5);
                    setTimeout(()=>this.playTone('alarm'), 600); // Loop
                } else if (type === 'correct') {
                    o.frequency.value = 800; g.gain.value = 0.1; o.start(); o.stop(t+0.1);
                } else {
                    o.type = 'sawtooth'; o.frequency.value = 100; g.gain.value = 0.2; o.start(); o.stop(t+0.3);
                }
            }
        };

        app.init();
    </script>
</body>
</html>